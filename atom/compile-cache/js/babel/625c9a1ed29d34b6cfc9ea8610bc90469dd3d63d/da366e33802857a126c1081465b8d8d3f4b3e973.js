var GitLogView = require("./git-log-class");
var BufferedProcess = require("atom").BufferedProcess;
var LogParser = require("./logparser");
var GitGraph = require("./gitgraph");
var $ = require("atom-space-pen-views").$;

var __bind = function __bind(fn, me) {
    return function () {
        return fn.apply(me, arguments);
    };
};

var safe_tags = function safe_tags(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
};

GitLogView.prototype.initialize = function (repo) {
    var editorFontSize = atom.config.get('editor.fontSize');
    var editorLineHeight = atom.config.get('editor.lineHeight');
    var fontScale = atom.config.get('git-log.fontScale');
    this.font_family = atom.config.get('git-log.fontFamily');
    this.repo = repo;
    this.info_panel.hide();
    this.path = repo.repo_name;

    this.font_size = editorFontSize * fontScale;
    this.line_height = Math.round(this.font_size * editorLineHeight);

    this.get_log();

    //this.resize_started = __bind(this.resize_started, this);
    //this.resize_table = __bind(this.resize_table, this);
    //this.resize_stopped = __bind(this.resize_stopped, this);
    this.hide = __bind(this.info_panel.hide, this);
};

GitLogView.prototype.get_log = function () {
    this.log = null;
    var concat = (function (self) {
        return function (data) {
            if (self.log == null) {
                self.log = "";
            }
            self.log += data;
        };
    })(this);

    var display_log = (function (self) {
        return function (data) {
            self.log_callback();
        };
    })(this);

    var args = ['log', '--decorate=full', '--date=default', '--pretty=fuller', '--all', '--parents', '--numstat', '--topo-order', '--raw'];
    var options = {};
    options.cwd = this.repo.getWorkingDirectory();

    return new BufferedProcess({
        command: 'git',
        args: args,
        options: options,
        stdout: concat,
        stderr: function stderr(data) {
            console.log(data.toString());
        },
        exit: display_log
    });
};

GitLogView.prototype.log_callback = function (data) {
    this.parser();

    //this.min_width = Math.floor(this.width()/10);

    this.fill_content();
    /**
    this.on('mousedown', '.resize-handle', (function(self) {
        return function(e) {
            self.resize_started(e);
        };
    })(this));
    **/
    atom.commands.add('.git-log', 'core:cancel', (function (self) {
        return function (e) {
            self.info_panel.hide();
        };
    })(this));

    atom.commands.add('.git-log', 'core:close', (function (self) {
        return function (e) {
            self.info_panel.hide();
        };
    })(this));

    atom.commands.add('.git-log', 'core:move-up', (function (self) {
        return function (e) {
            if (self.previous_line == null || self.previous_line == 1) return;

            var data = self.get_target_line(null, self.previous_line - 1);
            self.handle_scroll(data[0], 1);
            self.select_display_info(data[0], data[1]);
        };
    })(this));

    atom.commands.add('.git-log', 'core:move-down', (function (self) {
        return function (e) {
            if (self.previous_line == null || self.previous_line == self.log.length) return;

            var data = self.get_target_line(null, self.previous_line + 1);
            self.handle_scroll(data[0], 0);
            self.select_display_info(data[0], data[1]);
        };
    })(this));
};

GitLogView.prototype.parser = function () {
    this.log = LogParser(this.log);
    var graph = new GitGraph(this.main_panel.graph, this.log, this.line_height, 2);
};

GitLogView.prototype.fill_content = function () {
    var create_main_row = function create_main_row(log) {
        var html = '<tr><td><p> &nbsp;</p></td>';
        html += '<td><p>' + log.message.split('\n')[0] + '</p></td>';
        html += '<td><p>' + log.sha1.slice(0, 7) + '</p></td>';

        var date = log.author_date.split(/ /);

        html += '<td><p>' + date[2] + ' ' + date[1] + ' ' + date[4] + ' ' + date[3].slice(0, 5) + '</p></td>';
        html += '<td><p>' + log.author_name + '</p></td>';
        html += '</tr>';

        return html;
    };

    var set_widths = function set_widths(svg_width) {
        var total = main_panel.width();
        var diff = total - svg_width;

        // allocate widths in this ratio 70:10:10:10
        main_panel.comments.width(diff * .7);
        diff = diff * 0.1;
        main_panel.commit.width(diff);
        main_panel.date.width(diff);
        main_panel.author.width(diff);
    };

    var i, len;
    var main_panel = this.main_panel;
    for (i = 0; len = this.log.length, i < len; i++) {
        var log = this.log[i];
        main_panel.body.append(create_main_row(log));
    }

    this.css({
        'font-family': this.font_family,
        'font-size': this.font_size + 'px',
        'line-height': this.line_height + 'px'
    });

    main_panel.graph.css('top', main_panel.find('thead').height());

    var svg_width = main_panel.graph.width();
    main_panel.find('thead th:first-child').width(svg_width);
    set_widths(svg_width);

    main_panel.body.on("click", "tr", (function (self) {
        return function (e) {
            var data = self.get_target_line(e);
            self.select_display_info(data[0], data[1]);
        };
    })(this));
};

GitLogView.prototype.getTitle = function () {
    return "Git-log: " + this.path;
};

GitLogView.prototype.getURI = function () {
    return "git-log://" + this.path;
};

GitLogView.prototype.onDidChangeTitle = function () {
    return;
};

GitLogView.prototype.onDidChangeModified = function () {
    return;
};

GitLogView.prototype.get_image = function (email) {
    var crypto = require('crypto');
    var base = "http://www.gravatar.com/avatar/";
    return base + crypto.createHash('md5').update(email.toLowerCase().trim()).digest('hex') + "?s=64";
};

GitLogView.prototype.resize_started = function (event) {
    this.pos = {};
    this.pos.pointer_x = event.pageX;
    this.pos.left = $(event.target).position().left;

    this.pos.left_col = $(event.target).parents('.column');
    this.pos.right_col = $(this.pos.left_col.next());

    this.pos.left_width = this.pos.left_col.width();
    this.pos.right_width = this.pos.right_col.width();

    $(document).on('mousemove.git-log', this.resize_table);
    $(document).on('mouseup.git-log', this.resize_stopped);
    return false;
};

GitLogView.prototype.resize_table = function (event) {
    if (!this.pos) return;

    var x = event.pageX - this.pos.pointer_x + this.pos.left;
    this.pos.x = x;

    var inc = this.pos.x - this.pos.left;

    var w = this.pos.left_width + inc;
    var w2 = this.pos.right_width - inc;

    w = Math.max(this.min_width, w);
    w2 = Math.max(this.min_width, w2);

    //this.pos.left_col.width(w + 'px');
    //this.pos.right_col.width(w2 + 'px');

    this.pos.left_col.css('flex-basis', w + 'px');
    this.pos.right_col.css('flex-basis', w2 + 'px');
    return false;
};

GitLogView.prototype.resize_stopped = function (event) {
    this.pos = null;
    $(document).off('mousemove.git-log', this.resize_table);
    $(document).off('mouseup.git-log', this.resize_stopped);
};

GitLogView.prototype.get_target_line = function (event, line) {
    var line_no, target;
    if (event == null) {
        line_no = line;
        target = this.main_panel.body.find('tr:nth-child(' + line_no + ')');
    } else {
        line_no = $(event.currentTarget).index() + 1;
        target = $(event.currentTarget);
    }
    return [target, line_no];
};

GitLogView.prototype.handle_scroll = function (target, dir) {
    var offset_trigger = 3;
    var line_height = $(target).height() + 2; // accounting for the margin
    offset_trigger = offset_trigger * line_height;
    var window_height = this.main_panel.height();
    // move up
    if (dir == 1) {
        if (target.offset().top < offset_trigger) {
            this.main_panel.scrollTop(this.main_panel.scrollTop() - line_height);
        }
    } else if (dir == 0) {
        if (target.offset().top > window_height - offset_trigger) {
            this.main_panel.scrollTop(this.main_panel.scrollTop() + line_height);
        }
    }
};

GitLogView.prototype.select_display_info = function (target, line_no) {
    if (!this.info_panel.isVisible()) this.info_panel.show();

    this.info_panel.info_data.empty();
    this.info_panel.info_image.empty();
    this.info_panel.body.empty();

    var commit_data = this.log[line_no - 1];

    // background line higlighting
    if (this.previous_line != null) this.main_panel.body.find('tr:nth-child(' + this.previous_line + ')').removeClass('log-highlight');

    this.previous_line = line_no;
    target.addClass('log-highlight');

    this.info_panel.add_content("Commit:", commit_data.sha1 + " [" + commit_data.sha1.slice(0, 7) + "]");
    this.info_panel.add_content("Parents:", commit_data.parents.map(function (str) {
        return str.slice(0, 10);
    }).join(", "));
    this.info_panel.add_content("Author:", commit_data.author_name + ' <' + commit_data.author_email + '>');
    var date = commit_data.author_date.split(/ /);
    this.info_panel.add_content("Date:", date[2] + ' ' + date[1] + ' ' + date[4] + ' ' + date[3].slice(0, 8));

    // add committer related information
    if (commit_data.committer_name != commit_data.author_name) {
        this.info_panel.add_content("Committer:", commit_data.committer_name + ' <' + commit_data.committer_email + '>');
        date = commit_data.commit_date.split(/ /);
        this.info_panel.add_content("Commit Date:", date[2] + ' ' + date[1] + ' ' + date[4] + ' ' + date[3].slice(0, 8));
    }

    // remove refs/heads or refs/remotes
    if (commit_data.refs.length > 0) this.info_panel.add_content("Labels:", commit_data.refs.map(function (str) {
        return str.replace(/^.*\/(remotes|heads)\//, '');
    }).join(", "));
    this.info_panel.info_data.append('<p>' + safe_tags(commit_data.message).replace(/\n/g, '<br>') + "</p>");
    this.info_panel.info_image.append('<img src="' + safe_tags(this.get_image(commit_data.author_email)) + '"/>');

    if (commit_data.committer_name != commit_data.author_name) {
        this.info_panel.info_image.append('<img src="' + safe_tags(this.get_image(commit_data.committer_email)) + '"/>');
    }

    // fill the file information
    var i, len, temp, status_text;

    var create_row = function create_row(temp) {
        var temp, status_text, index;
        var html = '<tr>';

        if (temp[3] == 'A') status_text = 'added';else if (temp[3] == 'D') status_text = 'deleted';else status_text = 'modified';
        html += '<td><p>' + status_text + '</p></td>';

        index = temp[2].lastIndexOf('/');
        html += '<td><p>' + temp[2].slice(index + 1) + '</p></td>';
        html += '<td><p>' + (index >= 0 ? temp[2].slice(0, index) : '&nbsp;') + '</p></td>';
        html += '<td><p>' + temp[0] + '</p></td>';
        html += '<td><p>' + temp[1] + '</p></td>';
        html += '</tr>';

        return html;
    };

    this.info_panel.info_file.show();
    if (commit_data.file_line_diffs.length == 0) this.info_panel.info_file.hide();

    var i, len, temp;
    for (i = 1; len = commit_data.file_line_diffs.length, i < len; i++) {
        temp = create_row(commit_data.file_line_diffs[i]);
        this.info_panel.body.append(temp);
    }
};

module.exports = GitLogView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2FuZHJlaS8uYXRvbS9wYWNrYWdlcy9naXQtbG9nL2xpYi9naXQtbG9nLXZpZXcuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDNUMsSUFBSSxlQUFlLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLGVBQWUsQ0FBQztBQUN0RCxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDdkMsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3JDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7QUFFMUMsSUFBSSxNQUFNLEdBQUcsU0FBVCxNQUFNLENBQVksRUFBRSxFQUFFLEVBQUUsRUFBRTtBQUMxQixXQUFPLFlBQVc7QUFDZCxlQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0tBQ2xDLENBQUM7Q0FDTCxDQUFDOztBQUVGLElBQUksU0FBUyxHQUFHLFNBQVosU0FBUyxDQUFZLEdBQUcsRUFBRTtBQUMxQixXQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBQyxNQUFNLENBQUMsQ0FBRTtDQUMvRSxDQUFDOztBQUVGLFVBQVUsQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLFVBQVMsSUFBSSxFQUFFO0FBQzdDLFFBQUksY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDeEQsUUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQzVELFFBQUksU0FBUyxHQUFH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Z2l0LWxvZy9saWIvZ2l0LWxvZy12aWV3LmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEdpdExvZ1ZpZXcgPSByZXF1aXJlKFwiLi9naXQtbG9nLWNsYXNzXCIpO1xudmFyIEJ1ZmZlcmVkUHJvY2VzcyA9IHJlcXVpcmUoXCJhdG9tXCIpLkJ1ZmZlcmVkUHJvY2VzcztcbnZhciBMb2dQYXJzZXIgPSByZXF1aXJlKFwiLi9sb2dwYXJzZXJcIik7XG52YXIgR2l0R3JhcGggPSByZXF1aXJlKFwiLi9naXRncmFwaFwiKTtcbnZhciAkID0gcmVxdWlyZShcImF0b20tc3BhY2UtcGVuLXZpZXdzXCIpLiQ7XG5cbnZhciBfX2JpbmQgPSBmdW5jdGlvbihmbiwgbWUpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiBmbi5hcHBseShtZSwgYXJndW1lbnRzKTtcbiAgICB9O1xufTtcblxudmFyIHNhZmVfdGFncyA9IGZ1bmN0aW9uKHN0cikge1xuICAgIHJldHVybiBzdHIucmVwbGFjZSgvJi9nLCcmYW1wOycpLnJlcGxhY2UoLzwvZywnJmx0OycpLnJlcGxhY2UoLz4vZywnJmd0OycpIDtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbihyZXBvKSB7XG4gICAgdmFyIGVkaXRvckZvbnRTaXplID0gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IuZm9udFNpemUnKTtcbiAgICB2YXIgZWRpdG9yTGluZUhlaWdodCA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmxpbmVIZWlnaHQnKTtcbiAgICB2YXIgZm9udFNjYWxlID0gYXRvbS5jb25maWcuZ2V0KCdnaXQtbG9nLmZvbnRTY2FsZScpO1xuICAgIHRoaXMuZm9udF9mYW1pbHkgPSBhdG9tLmNvbmZpZy5nZXQoJ2dpdC1sb2cuZm9udEZhbWlseScpO1xuICAgIHRoaXMucmVwbyA9IHJlcG87XG4gICAgdGhpcy5pbmZvX3BhbmVsLmhpZGUoKTtcbiAgICB0aGlzLnBhdGggPSByZXBvLnJlcG9fbmFtZTtcblxuICAgIHRoaXMuZm9udF9zaXplID0gZWRpdG9yRm9udFNpemUgKiBmb250U2NhbGU7XG4gICAgdGhpcy5saW5lX2hlaWdodCA9IE1hdGgucm91bmQodGhpcy5mb250X3NpemUgKiBlZGl0b3JMaW5lSGVpZ2h0KTtcblxuICAgIHRoaXMuZ2V0X2xvZygpO1xuXG4gICAgLy90aGlzLnJlc2l6ZV9zdGFydGVkID0gX19iaW5kKHRoaXMucmVzaXplX3N0YXJ0ZWQsIHRoaXMpO1xuICAgIC8vdGhpcy5yZXNpemVfdGFibGUgPSBfX2JpbmQodGhpcy5yZXNpemVfdGFibGUsIHRoaXMpO1xuICAgIC8vdGhpcy5yZXNpemVfc3RvcHBlZCA9IF9fYmluZCh0aGlzLnJlc2l6ZV9zdG9wcGVkLCB0aGlzKTtcbiAgICB0aGlzLmhpZGUgPSBfX2JpbmQodGhpcy5pbmZvX3BhbmVsLmhpZGUsIHRoaXMpO1xufVxuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5nZXRfbG9nID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5sb2cgPSBudWxsO1xuICAgIHZhciBjb25jYXQgPSBmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICBpZihzZWxmLmxvZyA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5sb2cgPSBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VsZi5sb2cgKz0gZGF0YTtcbiAgICAgICAgfVxuICAgIH0odGhpcyk7XG5cbiAgICB2YXIgZGlzcGxheV9sb2cgPSBmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICBzZWxmLmxvZ19jYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgfSh0aGlzKTtcblxuICAgIHZhciBhcmdzID0gWydsb2cnLCAnLS1kZWNvcmF0ZT1mdWxsJywgJy0tZGF0ZT1kZWZhdWx0JywgJy0tcHJldHR5PWZ1bGxlcicsICctLWFsbCcsICctLXBhcmVudHMnLCAnLS1udW1zdGF0JywgJy0tdG9wby1vcmRlcicsICctLXJhdyddO1xuICAgIHZhciBvcHRpb25zID0ge307XG4gICAgb3B0aW9ucy5jd2QgPSB0aGlzLnJlcG8uZ2V0V29ya2luZ0RpcmVjdG9yeSgpO1xuXG4gICAgcmV0dXJuIG5ldyBCdWZmZXJlZFByb2Nlc3Moe1xuICAgICAgICBjb21tYW5kOiAnZ2l0JyxcbiAgICAgICAgYXJnczogYXJncyxcbiAgICAgICAgb3B0aW9uczogb3B0aW9ucyxcbiAgICAgICAgc3Rkb3V0OiBjb25jYXQsXG4gICAgICAgIHN0ZGVycjogZnVuY3Rpb24oZGF0YSkge2NvbnNvbGUubG9nKGRhdGEudG9TdHJpbmcoKSl9LFxuICAgICAgICBleGl0OiBkaXNwbGF5X2xvZ1xuICAgIH0pO1xufTtcblxuR2l0TG9nVmlldy5wcm90b3R5cGUubG9nX2NhbGxiYWNrID0gZnVuY3Rpb24oZGF0YSkge1xuICAgIHRoaXMucGFyc2VyKCk7XG5cbiAgICAvL3RoaXMubWluX3dpZHRoID0gTWF0aC5mbG9vcih0aGlzLndpZHRoKCkvMTApO1xuXG4gICAgdGhpcy5maWxsX2NvbnRlbnQoKTtcbiAgICAvKipcbiAgICB0aGlzLm9uKCdtb3VzZWRvd24nLCAnLnJlc2l6ZS1oYW5kbGUnLCAoZnVuY3Rpb24oc2VsZikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5yZXNpemVfc3RhcnRlZChlKTtcbiAgICAgICAgfTtcbiAgICB9KSh0aGlzKSk7XG4qKi9cbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnLmdpdC1sb2cnLCAnY29yZTpjYW5jZWwnLCAoZnVuY3Rpb24oc2VsZikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgc2VsZi5pbmZvX3BhbmVsLmhpZGUoKTtcbiAgICAgICAgfTtcbiAgICB9KSh0aGlzKSk7XG5cbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnLmdpdC1sb2cnLCAnY29yZTpjbG9zZScsIChmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBzZWxmLmluZm9fcGFuZWwuaGlkZSgpO1xuICAgICAgICB9O1xuICAgIH0pKHRoaXMpKTtcblxuICAgIGF0b20uY29tbWFuZHMuYWRkKCcuZ2l0LWxvZycsICdjb3JlOm1vdmUtdXAnLCAoZnVuY3Rpb24oc2VsZikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgaWYoKHNlbGYucHJldmlvdXNfbGluZSA9PSBudWxsKSB8fCAoc2VsZi5wcmV2aW91c19saW5lID09IDEpKVxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgdmFyIGRhdGEgPSBzZWxmLmdldF90YXJnZXRfbGluZShudWxsLCBzZWxmLnByZXZpb3VzX2xpbmUgLSAxKTtcbiAgICAgICAgICAgIHNlbGYuaGFuZGxlX3Njcm9sbChkYXRhWzBdLCAxKTtcbiAgICAgICAgICAgIHNlbGYuc2VsZWN0X2Rpc3BsYXlfaW5mbyhkYXRhWzBdLCBkYXRhWzFdKTtcbiAgICAgICAgfTtcbiAgICB9KSh0aGlzKSk7XG5cbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnLmdpdC1sb2cnLCAnY29yZTptb3ZlLWRvd24nLCAoZnVuY3Rpb24oc2VsZikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgaWYoKHNlbGYucHJldmlvdXNfbGluZSA9PSBudWxsKSB8fCAoc2VsZi5wcmV2aW91c19saW5lID09IHNlbGYubG9nLmxlbmd0aCkpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICB2YXIgZGF0YSA9IHNlbGYuZ2V0X3RhcmdldF9saW5lKG51bGwsIHNlbGYucHJldmlvdXNfbGluZSArIDEpO1xuICAgICAgICAgICAgc2VsZi5oYW5kbGVfc2Nyb2xsKGRhdGFbMF0sIDApO1xuICAgICAgICAgICAgc2VsZi5zZWxlY3RfZGlzcGxheV9pbmZvKGRhdGFbMF0sIGRhdGFbMV0pO1xuICAgICAgICB9O1xuICAgIH0pKHRoaXMpKTtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLnBhcnNlciA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMubG9nID0gTG9nUGFyc2VyKHRoaXMubG9nKTtcbiAgICB2YXIgZ3JhcGggPSBuZXcgR2l0R3JhcGgodGhpcy5tYWluX3BhbmVsLmdyYXBoLCB0aGlzLmxvZywgdGhpcy5saW5lX2hlaWdodCwgMik7XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5maWxsX2NvbnRlbnQgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgY3JlYXRlX21haW5fcm93ID0gZnVuY3Rpb24obG9nKSB7XG4gICAgICAgIHZhciBodG1sID0gJzx0cj48dGQ+PHA+ICZuYnNwOzwvcD48L3RkPic7XG4gICAgICAgIGh0bWwgKz0gJzx0ZD48cD4nICsgbG9nLm1lc3NhZ2Uuc3BsaXQoJ1xcbicpWzBdICsgJzwvcD48L3RkPic7XG4gICAgICAgIGh0bWwgKz0gJzx0ZD48cD4nICsgbG9nLnNoYTEuc2xpY2UoMCwgNykrICc8L3A+PC90ZD4nO1xuXG4gICAgICAgIHZhciBkYXRlID0gbG9nLmF1dGhvcl9kYXRlLnNwbGl0KC8gLyk7XG5cbiAgICAgICAgaHRtbCArPSAnPHRkPjxwPicgKyBkYXRlWzJdICsgJyAnICsgZGF0ZVsxXSArICcgJyArIGRhdGVbNF0gKyAnICcgKyBkYXRlWzNdLnNsaWNlKDAsNSkgKyAnPC9wPjwvdGQ+J1xuICAgICAgICBodG1sICs9ICc8dGQ+PHA+JyArIGxvZy5hdXRob3JfbmFtZSArICAnPC9wPjwvdGQ+J1xuICAgICAgICBodG1sICs9ICc8L3RyPidcblxuICAgICAgICByZXR1cm4gaHRtbDtcbiAgICB9O1xuXG4gICAgdmFyIHNldF93aWR0aHMgPSBmdW5jdGlvbihzdmdfd2lkdGgpIHtcbiAgICAgICAgdmFyIHRvdGFsID0gbWFpbl9wYW5lbC53aWR0aCgpO1xuICAgICAgICB2YXIgZGlmZiA9IHRvdGFsIC0gc3ZnX3dpZHRoO1xuXG4gICAgICAgIC8vIGFsbG9jYXRlIHdpZHRocyBpbiB0aGlzIHJhdGlvIDcwOjEwOjEwOjEwXG4gICAgICAgIG1haW5fcGFuZWwuY29tbWVudHMud2lkdGgoZGlmZiAqIC43KTtcbiAgICAgICAgZGlmZiA9IGRpZmYgKiAwLjE7XG4gICAgICAgIG1haW5fcGFuZWwuY29tbWl0LndpZHRoKGRpZmYpO1xuICAgICAgICBtYWluX3BhbmVsLmRhdGUud2lkdGgoZGlmZik7XG4gICAgICAgIG1haW5fcGFuZWwuYXV0aG9yLndpZHRoKGRpZmYpO1xuICAgIH1cblxuICAgIHZhciBpLCBsZW47XG4gICAgdmFyIG1haW5fcGFuZWwgPSB0aGlzLm1haW5fcGFuZWw7XG4gICAgZm9yKGk9MDsgbGVuID0gdGhpcy5sb2cubGVuZ3RoLCBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgdmFyIGxvZyA9IHRoaXMubG9nW2ldO1xuICAgICAgICBtYWluX3BhbmVsLmJvZHkuYXBwZW5kKGNyZWF0ZV9tYWluX3Jvdyhsb2cpKTtcbiAgICB9XG5cbiAgICB0aGlzLmNzcyh7XG4gICAgICAgICdmb250LWZhbWlseSc6IHRoaXMuZm9udF9mYW1pbHksXG4gICAgICAgICdmb250LXNpemUnOiB0aGlzLmZvbnRfc2l6ZSArICdweCcsXG4gICAgICAgICdsaW5lLWhlaWdodCc6IHRoaXMubGluZV9oZWlnaHQgKyAncHgnXG4gICAgfSk7XG5cbiAgICBtYWluX3BhbmVsLmdyYXBoLmNzcygndG9wJywgbWFpbl9wYW5lbC5maW5kKCd0aGVhZCcpLmhlaWdodCgpKTtcblxuICAgIHZhciBzdmdfd2lkdGggPSBtYWluX3BhbmVsLmdyYXBoLndpZHRoKCk7XG4gICAgbWFpbl9wYW5lbC5maW5kKCd0aGVhZCB0aDpmaXJzdC1jaGlsZCcpLndpZHRoKHN2Z193aWR0aCk7XG4gICAgc2V0X3dpZHRocyhzdmdfd2lkdGgpO1xuXG4gICAgbWFpbl9wYW5lbC5ib2R5Lm9uKFwiY2xpY2tcIiwgXCJ0clwiLCAoZnVuY3Rpb24oc2VsZikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgdmFyIGRhdGEgPSBzZWxmLmdldF90YXJnZXRfbGluZShlKTtcbiAgICAgICAgICAgIHNlbGYuc2VsZWN0X2Rpc3BsYXlfaW5mbyhkYXRhWzBdLCBkYXRhWzFdKTtcbiAgICAgICAgfTtcbiAgICB9KSh0aGlzKSk7XG59XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmdldFRpdGxlID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIFwiR2l0LWxvZzogXCIgKyB0aGlzLnBhdGg7XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5nZXRVUkkgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gXCJnaXQtbG9nOi8vXCIgKyB0aGlzLnBhdGg7XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5vbkRpZENoYW5nZVRpdGxlID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuO1xufTtcblxuR2l0TG9nVmlldy5wcm90b3R5cGUub25EaWRDaGFuZ2VNb2RpZmllZCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybjtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmdldF9pbWFnZSA9IGZ1bmN0aW9uKGVtYWlsKSB7XG4gICAgdmFyIGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuICAgIHZhciBiYXNlID0gXCJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIvXCI7XG4gICAgcmV0dXJuIGJhc2UgKyBjcnlwdG8uY3JlYXRlSGFzaCgnbWQ1JykudXBkYXRlKGVtYWlsLnRvTG93ZXJDYXNlKCkudHJpbSgpKS5kaWdlc3QoJ2hleCcpICsgXCI/cz02NFwiO1xufTtcblxuR2l0TG9nVmlldy5wcm90b3R5cGUucmVzaXplX3N0YXJ0ZWQgPSBmdW5jdGlvbihldmVudCkge1xuICAgIHRoaXMucG9zPXt9O1xuICAgIHRoaXMucG9zLnBvaW50ZXJfeCA9IGV2ZW50LnBhZ2VYO1xuICAgIHRoaXMucG9zLmxlZnQgPSAkKGV2ZW50LnRhcmdldCkucG9zaXRpb24oKS5sZWZ0O1xuXG4gICAgdGhpcy5wb3MubGVmdF9jb2wgPSAkKGV2ZW50LnRhcmdldCkucGFyZW50cygnLmNvbHVtbicpO1xuICAgIHRoaXMucG9zLnJpZ2h0X2NvbCA9ICQodGhpcy5wb3MubGVmdF9jb2wubmV4dCgpKTtcblxuICAgIHRoaXMucG9zLmxlZnRfd2lkdGggPSB0aGlzLnBvcy5sZWZ0X2NvbC53aWR0aCgpO1xuICAgIHRoaXMucG9zLnJpZ2h0X3dpZHRoID0gdGhpcy5wb3MucmlnaHRfY29sLndpZHRoKCk7XG5cbiAgICAkKGRvY3VtZW50KS5vbignbW91c2Vtb3ZlLmdpdC1sb2cnLCB0aGlzLnJlc2l6ZV90YWJsZSk7XG4gICAgJChkb2N1bWVudCkub24oJ21vdXNldXAuZ2l0LWxvZycsIHRoaXMucmVzaXplX3N0b3BwZWQpO1xuICAgIHJldHVybiBmYWxzZTtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLnJlc2l6ZV90YWJsZSA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgaWYoIXRoaXMucG9zKVxuICAgICAgICByZXR1cm47XG5cbiAgICB2YXIgeCA9IGV2ZW50LnBhZ2VYIC0gdGhpcy5wb3MucG9pbnRlcl94ICsgdGhpcy5wb3MubGVmdDtcbiAgICB0aGlzLnBvcy54ID0geDtcblxuICAgIHZhciBpbmMgPSB0aGlzLnBvcy54IC0gdGhpcy5wb3MubGVmdDtcblxuICAgIHZhciB3ID0gdGhpcy5wb3MubGVmdF93aWR0aCArIGluYztcbiAgICB2YXIgdzIgPSB0aGlzLnBvcy5yaWdodF93aWR0aCAtIGluYztcblxuICAgIHcgPSBNYXRoLm1heCh0aGlzLm1pbl93aWR0aCwgdyk7XG4gICAgdzIgPSBNYXRoLm1heCh0aGlzLm1pbl93aWR0aCwgdzIpO1xuXG4gICAgLy90aGlzLnBvcy5sZWZ0X2NvbC53aWR0aCh3ICsgJ3B4Jyk7XG4gICAgLy90aGlzLnBvcy5yaWdodF9jb2wud2lkdGgodzIgKyAncHgnKTtcblxuICAgIHRoaXMucG9zLmxlZnRfY29sLmNzcygnZmxleC1iYXNpcycsIHcgKyAncHgnKTtcbiAgICB0aGlzLnBvcy5yaWdodF9jb2wuY3NzKCdmbGV4LWJhc2lzJywgdzIgKyAncHgnKTtcbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLnJlc2l6ZV9zdG9wcGVkID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB0aGlzLnBvcyA9IG51bGw7XG4gICAgJChkb2N1bWVudCkub2ZmKCdtb3VzZW1vdmUuZ2l0LWxvZycsIHRoaXMucmVzaXplX3RhYmxlKTtcbiAgICAkKGRvY3VtZW50KS5vZmYoJ21vdXNldXAuZ2l0LWxvZycsIHRoaXMucmVzaXplX3N0b3BwZWQpO1xufVxuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5nZXRfdGFyZ2V0X2xpbmUgPSBmdW5jdGlvbihldmVudCwgbGluZSkge1xuICAgIHZhciBsaW5lX25vLCB0YXJnZXQ7XG4gICAgaWYoZXZlbnQgPT0gbnVsbCkge1xuICAgICAgICBsaW5lX25vID0gbGluZTtcbiAgICAgICAgdGFyZ2V0ID0gdGhpcy5tYWluX3BhbmVsLmJvZHkuZmluZCgndHI6bnRoLWNoaWxkKCcgKyBsaW5lX25vICsgJyknKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxpbmVfbm8gPSAkKGV2ZW50LmN1cnJlbnRUYXJnZXQpLmluZGV4KCkgKyAxO1xuICAgICAgICB0YXJnZXQgPSAkKGV2ZW50LmN1cnJlbnRUYXJnZXQpO1xuICAgIH1cbiAgICByZXR1cm4gW3RhcmdldCwgbGluZV9ub107XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5oYW5kbGVfc2Nyb2xsID0gZnVuY3Rpb24odGFyZ2V0LCBkaXIpIHtcbiAgICB2YXIgb2Zmc2V0X3RyaWdnZXIgPSAzO1xuICAgIHZhciBsaW5lX2hlaWdodCA9ICQodGFyZ2V0KS5oZWlnaHQoKSArIDI7IC8vIGFjY291bnRpbmcgZm9yIHRoZSBtYXJnaW5cbiAgICBvZmZzZXRfdHJpZ2dlciA9IG9mZnNldF90cmlnZ2VyICogbGluZV9oZWlnaHQ7XG4gICAgdmFyIHdpbmRvd19oZWlnaHQgPSB0aGlzLm1haW5fcGFuZWwuaGVpZ2h0KCk7XG4gICAgLy8gbW92ZSB1cFxuICAgIGlmKGRpciA9PSAxKSB7XG4gICAgICAgIGlmKHRhcmdldC5vZmZzZXQoKS50b3AgPCBvZmZzZXRfdHJpZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5tYWluX3BhbmVsLnNjcm9sbFRvcCh0aGlzLm1haW5fcGFuZWwuc2Nyb2xsVG9wKCkgLSBsaW5lX2hlaWdodCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBlbHNlIGlmKGRpciA9PSAwKSB7XG4gICAgICAgIGlmKHRhcmdldC5vZmZzZXQoKS50b3AgPiAod2luZG93X2hlaWdodCAtIG9mZnNldF90cmlnZ2VyKSkge1xuICAgICAgICAgICAgdGhpcy5tYWluX3BhbmVsLnNjcm9sbFRvcCh0aGlzLm1haW5fcGFuZWwuc2Nyb2xsVG9wKCkgKyBsaW5lX2hlaWdodCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5zZWxlY3RfZGlzcGxheV9pbmZvID0gZnVuY3Rpb24odGFyZ2V0LCBsaW5lX25vKSB7XG4gICAgaWYoIXRoaXMuaW5mb19wYW5lbC5pc1Zpc2libGUoKSlcbiAgICAgICAgdGhpcy5pbmZvX3BhbmVsLnNob3coKTtcblxuICAgIHRoaXMuaW5mb19wYW5lbC5pbmZvX2RhdGEuZW1wdHkoKTtcbiAgICB0aGlzLmluZm9fcGFuZWwuaW5mb19pbWFnZS5lbXB0eSgpO1xuICAgIHRoaXMuaW5mb19wYW5lbC5ib2R5LmVtcHR5KCk7XG5cbiAgICB2YXIgY29tbWl0X2RhdGEgPSB0aGlzLmxvZ1tsaW5lX25vIC0gMV07XG5cbiAgICAvLyBiYWNrZ3JvdW5kIGxpbmUgaGlnbGlnaHRpbmdcbiAgICBpZih0aGlzLnByZXZpb3VzX2xpbmUgIT0gbnVsbClcbiAgICAgICAgdGhpcy5tYWluX3BhbmVsLmJvZHkuZmluZCgndHI6bnRoLWNoaWxkKCcgKyB0aGlzLnByZXZpb3VzX2xpbmUgKyAnKScpXG4gICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ2xvZy1oaWdobGlnaHQnKTtcblxuICAgIHRoaXMucHJldmlvdXNfbGluZSA9IGxpbmVfbm87XG4gICAgdGFyZ2V0LmFkZENsYXNzKCdsb2ctaGlnaGxpZ2h0Jyk7XG5cbiAgICB0aGlzLmluZm9fcGFuZWwuYWRkX2NvbnRlbnQoXCJDb21taXQ6XCIsIGNvbW1pdF9kYXRhLnNoYTEgKyBcIiBbXCIgKyBjb21taXRfZGF0YS5zaGExLnNsaWNlKDAsNykgK1wiXVwiICk7XG4gICAgdGhpcy5pbmZvX3BhbmVsLmFkZF9jb250ZW50KFwiUGFyZW50czpcIiwgY29tbWl0X2RhdGEucGFyZW50cy5tYXAoZnVuY3Rpb24oc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gc3RyLnNsaWNlKDAsMTApO1xuICAgICAgICB9KS5qb2luKFwiLCBcIilcbiAgICApO1xuICAgIHRoaXMuaW5mb19wYW5lbC5hZGRfY29udGVudChcIkF1dGhvcjpcIiwgY29tbWl0X2RhdGEuYXV0aG9yX25hbWUgKyAnIDwnICsgY29tbWl0X2RhdGEuYXV0aG9yX2VtYWlsICsgJz4nKTtcbiAgICB2YXIgZGF0ZSA9IGNvbW1pdF9kYXRhLmF1dGhvcl9kYXRlLnNwbGl0KC8gLyk7XG4gICAgdGhpcy5pbmZvX3BhbmVsLmFkZF9jb250ZW50KFwiRGF0ZTpcIiwgZGF0ZVsyXSArICcgJyArIGRhdGVbMV0gKyAnICcgKyBkYXRlWzRdICsgJyAnICsgZGF0ZVszXS5zbGljZSgwLDgpKVxuXG4gICAgLy8gYWRkIGNvbW1pdHRlciByZWxhdGVkIGluZm9ybWF0aW9uXG4gICAgaWYoY29tbWl0X2RhdGEuY29tbWl0dGVyX25hbWUgIT0gY29tbWl0X2RhdGEuYXV0aG9yX25hbWUpIHtcbiAgICAgICAgdGhpcy5pbmZvX3BhbmVsLmFkZF9jb250ZW50KFwiQ29tbWl0dGVyOlwiLCBjb21taXRfZGF0YS5jb21taXR0ZXJfbmFtZSArICcgPCcgKyBjb21taXRfZGF0YS5jb21taXR0ZXJfZW1haWwgKyAnPicpO1xuICAgICAgICBkYXRlID0gY29tbWl0X2RhdGEuY29tbWl0X2RhdGUuc3BsaXQoLyAvKTtcbiAgICAgICAgdGhpcy5pbmZvX3BhbmVsLmFkZF9jb250ZW50KFwiQ29tbWl0IERhdGU6XCIsIGRhdGVbMl0gKyAnICcgKyBkYXRlWzFdICsgJyAnICsgZGF0ZVs0XSArICcgJyArIGRhdGVbM10uc2xpY2UoMCw4KSlcbiAgICB9XG5cbiAgICAvLyByZW1vdmUgcmVmcy9oZWFkcyBvciByZWZzL3JlbW90ZXNcbiAgICBpZihjb21taXRfZGF0YS5yZWZzLmxlbmd0aCA+IDApXG4gICAgICAgIHRoaXMuaW5mb19wYW5lbC5hZGRfY29udGVudChcIkxhYmVsczpcIiwgY29tbWl0X2RhdGEucmVmcy5tYXAoZnVuY3Rpb24oc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoL14uKlxcLyhyZW1vdGVzfGhlYWRzKVxcLy8sJycpO1xuICAgICAgICB9KS5qb2luKFwiLCBcIikpO1xuICAgIHRoaXMuaW5mb19wYW5lbC5pbmZvX2RhdGEuYXBwZW5kKCc8cD4nICsgc2FmZV90YWdzKGNvbW1pdF9kYXRhLm1lc3NhZ2UpLnJlcGxhY2UoL1xcbi9nLCAnPGJyPicpICsgXCI8L3A+XCIpO1xuICAgIHRoaXMuaW5mb19wYW5lbC5pbmZvX2ltYWdlLmFwcGVuZCgnPGltZyBzcmM9XCInICsgc2FmZV90YWdzKHRoaXMuZ2V0X2ltYWdlKGNvbW1pdF9kYXRhLmF1dGhvcl9lbWFpbCkpICsgJ1wiLz4nKVxuXG4gICAgaWYoY29tbWl0X2RhdGEuY29tbWl0dGVyX25hbWUgIT0gY29tbWl0X2RhdGEuYXV0aG9yX25hbWUpIHtcbiAgICAgICAgdGhpcy5pbmZvX3BhbmVsLmluZm9faW1hZ2UuYXBwZW5kKCc8aW1nIHNyYz1cIicgKyBzYWZlX3RhZ3ModGhpcy5nZXRfaW1hZ2UoY29tbWl0X2RhdGEuY29tbWl0dGVyX2VtYWlsKSkgKyAnXCIvPicpXG4gICAgfVxuXG4gICAgLy8gZmlsbCB0aGUgZmlsZSBpbmZvcm1hdGlvblxuICAgIHZhciBpLCBsZW4sIHRlbXAsIHN0YXR1c190ZXh0O1xuXG4gICAgdmFyIGNyZWF0ZV9yb3cgPSBmdW5jdGlvbih0ZW1wKSB7XG4gICAgICAgIHZhciB0ZW1wLCBzdGF0dXNfdGV4dCwgaW5kZXg7XG4gICAgICAgIHZhciBodG1sID0gJzx0cj4nO1xuXG4gICAgICAgIGlmKHRlbXBbM10gPT0gJ0EnKVxuICAgICAgICAgICAgc3RhdHVzX3RleHQgPSAnYWRkZWQnO1xuICAgICAgICBlbHNlIGlmKHRlbXBbM10gPT0gJ0QnKVxuICAgICAgICAgICAgc3RhdHVzX3RleHQgPSAnZGVsZXRlZCc7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHN0YXR1c190ZXh0ID0gJ21vZGlmaWVkJztcbiAgICAgICAgaHRtbCArPSAnPHRkPjxwPicgKyBzdGF0dXNfdGV4dCArICc8L3A+PC90ZD4nO1xuXG4gICAgICAgIGluZGV4ID0gdGVtcFsyXS5sYXN0SW5kZXhPZignLycpO1xuICAgICAgICBodG1sICs9ICc8dGQ+PHA+JyArIHRlbXBbMl0uc2xpY2UoaW5kZXggKyAxKSArICc8L3A+PC90ZD4nO1xuICAgICAgICBodG1sICs9ICc8dGQ+PHA+JyArICgoaW5kZXggPj0gMCkgPyB0ZW1wWzJdLnNsaWNlKDAsIGluZGV4KSA6ICcmbmJzcDsnKSArICc8L3A+PC90ZD4nXG4gICAgICAgIGh0bWwgKz0gJzx0ZD48cD4nICsgdGVtcFswXSArICAnPC9wPjwvdGQ+JztcbiAgICAgICAgaHRtbCArPSAnPHRkPjxwPicgKyB0ZW1wWzFdICsgICc8L3A+PC90ZD4nO1xuICAgICAgICBodG1sICs9ICc8L3RyPic7XG5cbiAgICAgICAgcmV0dXJuIGh0bWw7XG4gICAgfTtcblxuICAgIHRoaXMuaW5mb19wYW5lbC5pbmZvX2ZpbGUuc2hvdygpO1xuICAgIGlmKGNvbW1pdF9kYXRhLmZpbGVfbGluZV9kaWZmcy5sZW5ndGggPT0gMClcbiAgICAgICAgdGhpcy5pbmZvX3BhbmVsLmluZm9fZmlsZS5oaWRlKCk7XG5cbiAgICB2YXIgaSwgbGVuLCB0ZW1wO1xuICAgIGZvcihpPTE7IGxlbj1jb21taXRfZGF0YS5maWxlX2xpbmVfZGlmZnMubGVuZ3RoLCBpPGxlbjtpKyspIHtcbiAgICAgICAgdGVtcCA9IGNyZWF0ZV9yb3coY29tbWl0X2RhdGEuZmlsZV9saW5lX2RpZmZzW2ldKTtcbiAgICAgICAgdGhpcy5pbmZvX3BhbmVsLmJvZHkuYXBwZW5kKHRlbXApO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gR2l0TG9nVmlldztcbiJdfQ==