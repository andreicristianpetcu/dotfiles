var author_regex = /([^<]+)<([^>]+)>/;
var headers = {
    'Author': function Author(current_commit, author) {
        var capture = author_regex.exec(author);
        if (capture) {
            current_commit.author_name = capture[1].trim();
            current_commit.author_email = capture[2].trim();
        } else {
            current_commit.author_name = author;
        }
    },

    'Commit': function Commit(current_commit, author) {
        var capture = author_regex.exec(author);
        if (capture) {
            current_commit.committer_name = capture[1].trim();
            current_commit.committer_email = capture[2].trim();
        } else {
            current_commit.committer_name = author;
        }
    },

    'AuthorDate': function AuthorDate(current_commit, date) {
        current_commit.author_date = date;
    },

    'CommitDate': function CommitDate(current_commit, date) {
        current_commit.commit_date = date;
    },

    'Reflog': function Reflog(current_commit, data) {
        current_commit.reflog_name = data.substring(0, data.indexOf(' '));
        var author = data.substring(data.indexOf(' ') + 2, data.length - 1);
        var capture = author_regex.exec(author);
        if (capture) {
            current_commit.reflog_author_name = capture[1].trim();
            current_commit.reflog_author_email = capture[2].trim();
        } else {
            current_commit.reflog_author_name = author;
        }
    }
};

var parse_git_log = function parse_git_log(data) {
    var commits = [];
    var current_commit;
    var temp_file_change = [];
    var parse_commit_line = function parse_commit_line(row) {
        if (!row.trim()) return;
        current_commit = { refs: [], file_line_diffs: [] };
        var ss = row.split('(');
        var sha1s = ss[0].split(' ').slice(1).filter(function (sha1) {
            return sha1 && sha1.length;
        });
        current_commit.sha1 = sha1s[0];
        current_commit.parents = sha1s.slice(1);
        if (ss[1]) {
            var refs = ss[1].slice(0, ss[1].length - 1);
            current_commit.refs = refs.split(', ');
        }
        commits.push(current_commit);
        parser = parse_header_line;
    };
    var parse_header_line = function parse_header_line(row) {
        if (row.trim() == '') {
            parser = parse_commit_message;
        } else {
            for (var key in headers) {
                if (row.indexOf(key + ': ') == 0) {
                    headers[key](current_commit, row.slice((key + ': ').length).trim());
                    return;
                }
            }
        }
    };
    var parse_commit_message = function parse_commit_message(row, index) {
        if (/:[\d]+\s[\d]+\s[\d|\w]+.../g.test(rows[index + 1])) {
            //if (/[\d-]+\t[\d-]+\t.+/g.test(rows[index + 1])) {
            parser = parse_file_changes;
            return;
        }
        if (rows[index + 1] && rows[index + 1].indexOf('commit ') == 0) {
            parser = parse_commit_line;
            return;
        }
        if (current_commit.message) current_commit.message += '\n';else current_commit.message = '';
        current_commit.message += row.trim();
    };
    var parse_file_changes = function parse_file_changes(row, index) {
        if (rows.length === index + 1 || rows[index + 1] && rows[index + 1].indexOf('commit ') === 0) {
            var total = [0, 0, 'Total'];
            for (var n = 0; n < current_commit.file_line_diffs.length; n++) {
                var file_line_diff = current_commit.file_line_diffs[n];
                if (!isNaN(parseInt(file_line_diff[0], 10))) {
                    total[0] += file_line_diff[0] = parseInt(file_line_diff[0], 10);
                }
                if (!isNaN(parseInt(file_line_diff[1], 10))) {
                    total[1] += file_line_diff[1] = parseInt(file_line_diff[1], 10);
                }
            }
            current_commit.file_line_diffs.splice(0, 0, total);
            parser = parse_commit_line;
            return;
        }
        if (row[0] == ':') {
            var val = row[row.lastIndexOf('... ') + 4];
            temp_file_change.push(val);
        } else {
            current_commit.file_line_diffs.push(row.split('\t').concat(temp_file_change.shift()));
        }
    };
    var parser = parse_commit_line;
    var rows = data.split('\n');
    rows.forEach(function (row, index) {
        parser(row, index);
    });

    commits.forEach(function (commit) {
        commit.message = typeof commit.message === 'string' ? commit.message.trim() : '';
    });
    return commits;
};

module.exports = parse_git_log;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2FuZHJlaS8uYXRvbS9wYWNrYWdlcy9naXQtbG9nL2xpYi9sb2dwYXJzZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSSxZQUFZLEdBQUcsa0JBQWtCLENBQUM7QUFDdEMsSUFBSSxPQUFPLEdBQUc7QUFDVixZQUFRLEVBQUUsZ0JBQVMsY0FBYyxFQUFFLE1BQU0sRUFBRTtBQUN2QyxZQUFJLE9BQU8sR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3hDLFlBQUcsT0FBTyxFQUFFO0FBQ1IsMEJBQWMsQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQy9DLDBCQUFjLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNuRCxNQUFNO0FBQ0gsMEJBQWMsQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDO1NBQ3ZDO0tBQ0o7O0FBRUQsWUFBUSxFQUFFLGdCQUFTLGNBQWMsRUFBRSxNQUFNLEVBQUU7QUFDdkMsWUFBSSxPQUFPLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN4QyxZQUFJLE9BQU8sRUFBRTtBQUNULDBCQUFjLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNsRCwwQkFBYyxDQUFDLGVBQWUsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDdEQsTUFDSTtBQUNELDBCQUFjLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQztTQUMxQztLQUNKOztBQUVELGdCQUFZLEVBQUUsb0JBQVMsY0FBYyxFQUFFLElBQUksRUFBRTtBQUN6QyxzQkFBYyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7S0FDckM7O0FBRUQsZ0JBQVksRUFBRSxvQkFBUyxjQUFjLEVBQUUsSUFBSSxF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QUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ3pGO0tBQ0osQ0FBQTtBQUNELFFBQUksTUFBTSxHQUFHLGlCQUFpQixDQUFDO0FBQy9CLFFBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDNUIsUUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFTLEdBQUcsRUFBRSxLQUFLLEVBQUU7QUFDOUIsY0FBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUN0QixDQUFDLENBQUM7O0FBRUgsV0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFTLE1BQU0sRUFBRTtBQUFFLGNBQU0sQ0FBQyxPQUFPLEdBQUcsQUFBQyxPQUFPLE1BQU0sQ0FBQyxPQUFPLEtBQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDO0tBQUUsQ0FBQyxDQUFDO0FBQzFILFdBQU8sT0FBTyxDQUFDO0NBQ2xCLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMiLCJmaWxlIjoiL2hvbWUvYW5kcmVpLy5hdG9tL3BhY2thZ2VzL2dpdC1sb2cvbGliL2xvZ3BhcnNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBhdXRob3JfcmVnZXggPSAvKFtePF0rKTwoW14+XSspPi87XG52YXIgaGVhZGVycyA9IHtcbiAgICAnQXV0aG9yJzogZnVuY3Rpb24oY3VycmVudF9jb21taXQsIGF1dGhvcikge1xuICAgICAgICB2YXIgY2FwdHVyZSA9IGF1dGhvcl9yZWdleC5leGVjKGF1dGhvcik7XG4gICAgICAgIGlmKGNhcHR1cmUpIHtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmF1dGhvcl9uYW1lID0gY2FwdHVyZVsxXS50cmltKCk7XG4gICAgICAgICAgICBjdXJyZW50X2NvbW1pdC5hdXRob3JfZW1haWwgPSBjYXB0dXJlWzJdLnRyaW0oKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmF1dGhvcl9uYW1lID0gYXV0aG9yO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgICdDb21taXQnOiBmdW5jdGlvbihjdXJyZW50X2NvbW1pdCwgYXV0aG9yKSB7XG4gICAgICAgIHZhciBjYXB0dXJlID0gYXV0aG9yX3JlZ2V4LmV4ZWMoYXV0aG9yKTtcbiAgICAgICAgaWYgKGNhcHR1cmUpIHtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmNvbW1pdHRlcl9uYW1lID0gY2FwdHVyZVsxXS50cmltKCk7XG4gICAgICAgICAgICBjdXJyZW50X2NvbW1pdC5jb21taXR0ZXJfZW1haWwgPSBjYXB0dXJlWzJdLnRyaW0oKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmNvbW1pdHRlcl9uYW1lID0gYXV0aG9yO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgICdBdXRob3JEYXRlJzogZnVuY3Rpb24oY3VycmVudF9jb21taXQsIGRhdGUpIHtcbiAgICAgICAgY3VycmVudF9jb21taXQuYXV0aG9yX2RhdGUgPSBkYXRlO1xuICAgIH0sXG5cbiAgICAnQ29tbWl0RGF0ZSc6IGZ1bmN0aW9uKGN1cnJlbnRfY29tbWl0LCBkYXRlKSB7XG4gICAgICAgIGN1cnJlbnRfY29tbWl0LmNvbW1pdF9kYXRlID0gZGF0ZTtcbiAgICB9LFxuXG4gICAgJ1JlZmxvZyc6IGZ1bmN0aW9uKGN1cnJlbnRfY29tbWl0LCBkYXRhKSB7XG4gICAgICAgIGN1cnJlbnRfY29tbWl0LnJlZmxvZ19uYW1lID0gZGF0YS5zdWJzdHJpbmcoMCwgZGF0YS5pbmRleE9mKCcgJykpO1xuICAgICAgICB2YXIgYXV0aG9yID0gZGF0YS5zdWJzdHJpbmcoZGF0YS5pbmRleE9mKCcgJykgKyAyLCBkYXRhLmxlbmd0aCAtIDEpO1xuICAgICAgICB2YXIgY2FwdHVyZSA9IGF1dGhvcl9yZWdleC5leGVjKGF1dGhvcik7XG4gICAgICAgIGlmIChjYXB0dXJlKSB7XG4gICAgICAgICAgICBjdXJyZW50X2NvbW1pdC5yZWZsb2dfYXV0aG9yX25hbWUgPSBjYXB0dXJlWzFdLnRyaW0oKTtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LnJlZmxvZ19hdXRob3JfZW1haWwgPSBjYXB0dXJlWzJdLnRyaW0oKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LnJlZmxvZ19hdXRob3JfbmFtZSA9IGF1dGhvcjtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG52YXIgcGFyc2VfZ2l0X2xvZyA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgY29tbWl0cyA9IFtdO1xuICAgIHZhciBjdXJyZW50X2NvbW1pdDtcbiAgICB2YXIgdGVtcF9maWxlX2NoYW5nZSA9IFtdO1xuICAgIHZhciBwYXJzZV9jb21taXRfbGluZSA9IGZ1bmN0aW9uKHJvdykge1xuICAgICAgICBpZiAoIXJvdy50cmltKCkpIHJldHVybjtcbiAgICAgICAgY3VycmVudF9jb21taXQgPSB7IHJlZnM6IFtdLCBmaWxlX2xpbmVfZGlmZnM6IFtdIH07XG4gICAgICAgIHZhciBzcyA9IHJvdy5zcGxpdCgnKCcpO1xuICAgICAgICB2YXIgc2hhMXMgPSBzc1swXS5zcGxpdCgnICcpLnNsaWNlKDEpLmZpbHRlcihmdW5jdGlvbihzaGExKSB7IHJldHVybiBzaGExICYmIHNoYTEubGVuZ3RoOyB9KTtcbiAgICAgICAgY3VycmVudF9jb21taXQuc2hhMSA9IHNoYTFzWzBdO1xuICAgICAgICBjdXJyZW50X2NvbW1pdC5wYXJlbnRzID0gc2hhMXMuc2xpY2UoMSk7XG4gICAgICAgIGlmIChzc1sxXSkge1xuICAgICAgICAgICAgdmFyIHJlZnMgPSBzc1sxXS5zbGljZSgwLCBzc1sxXS5sZW5ndGggLSAxKTtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LnJlZnMgPSByZWZzLnNwbGl0KCcsICcpO1xuICAgICAgICB9XG4gICAgICAgIGNvbW1pdHMucHVzaChjdXJyZW50X2NvbW1pdCk7XG4gICAgICAgIHBhcnNlciA9IHBhcnNlX2hlYWRlcl9saW5lO1xuICAgIH1cbiAgICB2YXIgcGFyc2VfaGVhZGVyX2xpbmUgPSBmdW5jdGlvbihyb3cpIHtcbiAgICAgICAgaWYgKHJvdy50cmltKCkgPT0gJycpIHtcbiAgICAgICAgICAgIHBhcnNlciA9IHBhcnNlX2NvbW1pdF9tZXNzYWdlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGhlYWRlcnMpIHtcbiAgICAgICAgICAgICAgICBpZiAocm93LmluZGV4T2Yoa2V5ICsgJzogJykgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBoZWFkZXJzW2tleV0oY3VycmVudF9jb21taXQsIHJvdy5zbGljZSgoa2V5ICsgJzogJykubGVuZ3RoKS50cmltKCkpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHBhcnNlX2NvbW1pdF9tZXNzYWdlID0gZnVuY3Rpb24ocm93LCBpbmRleCkge1xuICAgICAgICBpZigvOltcXGRdK1xcc1tcXGRdK1xcc1tcXGR8XFx3XSsuLi4vZy50ZXN0KHJvd3NbaW5kZXggKyAxXSkpIHtcbiAgICAgICAgLy9pZiAoL1tcXGQtXStcXHRbXFxkLV0rXFx0LisvZy50ZXN0KHJvd3NbaW5kZXggKyAxXSkpIHtcbiAgICAgICAgICAgIHBhcnNlciA9IHBhcnNlX2ZpbGVfY2hhbmdlcztcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocm93c1tpbmRleCArIDFdICYmIHJvd3NbaW5kZXggKyAxXS5pbmRleE9mKCdjb21taXQgJykgPT0gMCkge1xuICAgICAgICAgICAgcGFyc2VyID0gcGFyc2VfY29tbWl0X2xpbmU7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGN1cnJlbnRfY29tbWl0Lm1lc3NhZ2UpXG4gICAgICAgICAgICBjdXJyZW50X2NvbW1pdC5tZXNzYWdlICs9ICdcXG4nO1xuICAgICAgICBlbHNlIGN1cnJlbnRfY29tbWl0Lm1lc3NhZ2UgPSAnJztcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0Lm1lc3NhZ2UgKz0gcm93LnRyaW0oKTtcbiAgICB9XG4gICAgdmFyIHBhcnNlX2ZpbGVfY2hhbmdlcyA9IGZ1bmN0aW9uKHJvdywgaW5kZXgpIHtcbiAgICAgICAgaWYgKHJvd3MubGVuZ3RoID09PSBpbmRleCArIDEgfHwgcm93c1tpbmRleCArIDFdICYmIHJvd3NbaW5kZXggKyAxXS5pbmRleE9mKCdjb21taXQgJykgPT09IDApIHtcbiAgICAgICAgICAgIHZhciB0b3RhbCA9IFswLCAwLCAnVG90YWwnXTtcbiAgICAgICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgY3VycmVudF9jb21taXQuZmlsZV9saW5lX2RpZmZzLmxlbmd0aDsgbisrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGZpbGVfbGluZV9kaWZmID0gY3VycmVudF9jb21taXQuZmlsZV9saW5lX2RpZmZzW25dO1xuICAgICAgICAgICAgICAgIGlmICghaXNOYU4ocGFyc2VJbnQoZmlsZV9saW5lX2RpZmZbMF0sIDEwKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWxbMF0gKz0gZmlsZV9saW5lX2RpZmZbMF0gPSBwYXJzZUludChmaWxlX2xpbmVfZGlmZlswXSwgMTApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHBhcnNlSW50KGZpbGVfbGluZV9kaWZmWzFdLCAxMCkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvdGFsWzFdICs9IGZpbGVfbGluZV9kaWZmWzFdID0gcGFyc2VJbnQoZmlsZV9saW5lX2RpZmZbMV0sIDEwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjdXJyZW50X2NvbW1pdC5maWxlX2xpbmVfZGlmZnMuc3BsaWNlKDAsMCwgdG90YWwpO1xuICAgICAgICAgICAgcGFyc2VyID0gcGFyc2VfY29tbWl0X2xpbmU7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYocm93WzBdID09ICc6Jykge1xuICAgICAgICAgICAgdmFyIHZhbCA9IHJvd1tyb3cubGFzdEluZGV4T2YoJy4uLiAnKSArIDRdO1xuICAgICAgICAgICAgdGVtcF9maWxlX2NoYW5nZS5wdXNoKHZhbCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjdXJyZW50X2NvbW1pdC5maWxlX2xpbmVfZGlmZnMucHVzaChyb3cuc3BsaXQoJ1xcdCcpLmNvbmNhdCh0ZW1wX2ZpbGVfY2hhbmdlLnNoaWZ0KCkpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgcGFyc2VyID0gcGFyc2VfY29tbWl0X2xpbmU7XG4gICAgdmFyIHJvd3MgPSBkYXRhLnNwbGl0KCdcXG4nKTtcbiAgICByb3dzLmZvckVhY2goZnVuY3Rpb24ocm93LCBpbmRleCkge1xuICAgICAgICBwYXJzZXIocm93LCBpbmRleCk7XG4gICAgfSk7XG5cbiAgICBjb21taXRzLmZvckVhY2goZnVuY3Rpb24oY29tbWl0KSB7IGNvbW1pdC5tZXNzYWdlID0gKHR5cGVvZiBjb21taXQubWVzc2FnZSkgPT09ICdzdHJpbmcnID8gY29tbWl0Lm1lc3NhZ2UudHJpbSgpIDogJyc7IH0pO1xuICAgIHJldHVybiBjb21taXRzO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBwYXJzZV9naXRfbG9nO1xuIl19