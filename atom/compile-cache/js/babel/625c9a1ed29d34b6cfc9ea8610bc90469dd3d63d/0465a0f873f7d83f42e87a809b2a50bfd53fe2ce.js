Object.defineProperty(exports, '__esModule', {
	value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _eventKit = require('event-kit');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _reactDomPragma = require('react-dom-pragma');

var _reactDomPragma2 = _interopRequireDefault(_reactDomPragma);

var _lazyReq = require('lazy-req');

var _lazyReq2 = _interopRequireDefault(_lazyReq);

'use babel';

var lazyReq = (0, _lazyReq2['default'])(require);
var lodash = lazyReq('lodash');
var jshint = lazyReq('jshint');
var jsxhint = lazyReq('jshint-jsx');
var cli = lazyReq('jshint/src/cli');
var loadConfig = lazyReq('./load-config');
var plugin = {};
var markersByEditorId = {};
var errorsByEditorId = {};
var subscriptionTooltips = new _eventKit.CompositeDisposable();
var _ = undefined;

var SUPPORTED_GRAMMARS = ['source.js', 'source.jsx', 'source.js.jsx'];

var jsHintStatusBar = document.createElement('span');
jsHintStatusBar.setAttribute('id', 'jshint-statusbar');
jsHintStatusBar.classList.add('inline-block');

var updateStatusText = function updateStatusText(line, character, reason) {
	jsHintStatusBar.textContent = line && character && reason ? 'JSHint ' + line + ':' + character + ' ' + reason : '';
};

var getMarkersForEditor = function getMarkersForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && markersByEditorId[editor.id]) {
		return markersByEditorId[editor.id];
	}

	return {};
};

var getErrorsForEditor = function getErrorsForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && errorsByEditorId[editor.id]) {
		return errorsByEditorId[editor.id];
	}

	return [];
};

var destroyMarkerAtRow = function destroyMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (markersByEditorId[editor.id] && markersByEditorId[editor.id][row]) {
		markersByEditorId[editor.id][row].destroy();
		delete markersByEditorId[editor.id][row];
	}
};

var getRowForError = function getRowForError(error) {
	// JSHint reports `line: 0` when config error
	var line = error[0].line || 1;

	var row = line - 1;

	return row;
};

var clearOldMarkers = function clearOldMarkers(errors) {
	subscriptionTooltips.dispose();

	var rows = _.map(errors, function (error) {
		return getRowForError(error);
	});

	var oldMarkers = getMarkersForEditor();
	_.each(_.keys(oldMarkers), function (row) {
		if (!_.contains(rows, row)) {
			destroyMarkerAtRow(row);
		}
	});
};

var saveMarker = function saveMarker(marker, row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		markersByEditorId[editor.id] = {};
	}

	markersByEditorId[editor.id][row] = marker;
};

var getMarkerAtRow = function getMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		return null;
	}

	return markersByEditorId[editor.id][row];
};

var updateStatusbar = function updateStatusbar() {
	var statusBar = atom.views.getView(atom.workspace).querySelector('.status-bar');

	if (!statusBar) {
		return;
	}

	if (!jsHintStatusBar.parentNode) {
		statusBar.addLeftTile({ item: jsHintStatusBar });
	}

	var editor = atom.workspace.getActiveTextEditor();

	if (!editor || !errorsByEditorId[editor.id]) {
		updateStatusText();
		return;
	}

	var line = editor.getCursorBufferPosition().row + 1;
	var error = errorsByEditorId[editor.id][line] || _.first(_.compact(errorsByEditorId[editor.id]));
	error = error[0];

	updateStatusText(error.line, error.character, error.reason);
};

var getReasonsForError = function getReasonsForError(error) {
	return _.map(error, function (el) {
		return el.character + ': ' + el.reason;
	});
};

var addReasons = function addReasons(marker, error) {
	var row = getRowForError(error);
	var editorElement = atom.views.getView(atom.workspace.getActiveTextEditor());
	var reasons = '<div class="jshint-errors">' + getReasonsForError(error).join('<br>') + '</div>';
	var target = editorElement.shadowRoot.querySelectorAll('.jshint-line-number.line-number-' + row);
	var tooltip = atom.tooltips.add(target, {
		title: reasons,
		placement: 'bottom',
		delay: { show: 200 }
	});

	subscriptionTooltips.add(tooltip);
};

var displayError = function displayError(err) {
	var row = getRowForError(err);

	if (getMarkerAtRow(row)) {
		return;
	}

	var editor = atom.workspace.getActiveTextEditor();
	var marker = editor.markBufferRange([[row, 0], [row, 1]]);
	editor.decorateMarker(marker, { type: 'line', 'class': 'jshint-line' });
	editor.decorateMarker(marker, { type: 'line-number', 'class': 'jshint-line-number' });
	saveMarker(marker, row);
	addReasons(marker, err);
};

var displayErrors = function displayErrors() {
	var errors = _.compact(getErrorsForEditor());
	clearOldMarkers(errors);
	updateStatusbar();
	_.each(errors, displayError);
};

var removeMarkersForEditorId = function removeMarkersForEditorId(id) {
	if (markersByEditorId[id]) {
		delete markersByEditorId[id];
	}
};

var removeErrorsForEditorId = function removeErrorsForEditorId(id) {
	if (errorsByEditorId[id]) {
		delete errorsByEditorId[id];
	}
};

var lint = function lint() {
	var editor = atom.workspace.getActiveTextEditor();

	if (!editor) {
		return;
	}

	if (SUPPORTED_GRAMMARS.indexOf(editor.getGrammar().scopeName) === -1) {
		return;
	}

	var file = editor.getURI();

	// Hack to make JSHint look for .jshintignore in the correct dir
	// Because JSHint doesn't use its `cwd` option
	process.chdir(_path2['default'].dirname(file));

	// Remove errors and don't lint if file is ignored in .jshintignore
	if (file && cli().gather({ args: [file] }).length === 0) {
		removeErrorsForEditorId(editor.id);
		displayErrors();
		removeMarkersForEditorId(editor.id);
		return;
	}

	var config = file ? loadConfig()(file) : {};
	var linter = atom.config.get('jshint.supportLintingJsx') || atom.config.get('jshint.transformJsx') ? jsxhint().JSXHINT : jshint().JSHINT;

	if (Object.keys(config).length === 0 && atom.config.get('jshint.onlyConfig')) {
		return;
	}

	var origCode = editor.getText();
	var grammarScope = editor.getGrammar().scopeName;
	var isJsx = grammarScope === 'source.jsx' || grammarScope === 'source.js.jsx';
	var code = isJsx ? (0, _reactDomPragma2['default'])(origCode) : origCode;
	var pragmaWasAdded = code !== origCode;

	try {
		linter(code, config, config.globals);
	} catch (err) {}

	removeErrorsForEditorId(editor.id);

	// workaround the errors array sometimes containing `null`
	var errors = _.compact(linter.errors);

	if (errors.length > 0) {
		(function () {
			// aggregate same-line errors
			var ret = [];
			_.each(errors, function (el) {
				if (pragmaWasAdded) {
					el.line--;
				}

				var l = el.line;

				if (Array.isArray(ret[l])) {
					ret[l].push(el);

					ret[l] = _.sortBy(ret[l], function (el) {
						return el.character;
					});
				} else {
					ret[l] = [el];
				}
			});

			errorsByEditorId[editor.id] = ret;
		})();
	}

	displayErrors();
};

var debouncedLint = null;
var debouncedDisplayErrors = null;
var debouncedUpdateStatusbar = null;

var registerEvents = function registerEvents() {
	lint();
	var workspaceElement = atom.views.getView(atom.workspace);

	debouncedLint = debouncedLint || _.debounce(lint, 50);
	debouncedDisplayErrors = debouncedDisplayErrors || _.debounce(displayErrors, 200);
	debouncedUpdateStatusbar = debouncedUpdateStatusbar || _.debounce(updateStatusbar, 100);

	atom.workspace.observeTextEditors(function (editor) {
		var buffer = editor.getBuffer();

		editor.emitter.off('scroll-top-changed', debouncedDisplayErrors);
		editor.emitter.off('did-change-cursor-position', debouncedUpdateStatusbar);
		buffer.emitter.off('did-save did-change-modified', debouncedLint);

		if (!atom.config.get('jshint.validateOnlyOnSave')) {
			buffer.onDidChangeModified(debouncedLint);
		}

		buffer.onDidSave(debouncedLint);

		editor.onDidChangeScrollTop(debouncedDisplayErrors);
		editor.onDidChangeCursorPosition(debouncedUpdateStatusbar);
	});

	workspaceElement.addEventListener('editor:will-be-removed', function (e, editorView) {
		if (editorView && editorView.editor) {
			removeErrorsForEditorId(editorView.editor.id);
			removeMarkersForEditorId(editorView.editor.id);
		}
	});
};

var config = plugin.config = {
	onlyConfig: {
		type: 'boolean',
		'default': false,
		description: 'Disable linter if there is no config file found for the linter.'
	},
	validateOnlyOnSave: {
		type: 'boolean',
		'default': false
	},
	supportLintingJsx: {
		type: 'boolean',
		'default': false,
		title: 'Support Linting JSX'
	}
};

exports.config = config;
var activate = plugin.activate = function () {
	_ = lodash();
	registerEvents();
	atom.config.observe('jshint.onlyConfig', registerEvents);
	atom.config.observe('jshint.validateOnlyOnSave', registerEvents);
	atom.commands.add('atom-workspace', 'jshint:lint', lint);
};

exports.activate = activate;
exports['default'] = plugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2FuZHJlaS8uYXRvbS9wYWNrYWdlcy9qc2hpbnQvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O3dCQUNrQyxXQUFXOztvQkFDNUIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7dUJBQ3JCLFVBQVU7Ozs7QUFKbEMsV0FBVyxDQUFDOztBQU1aLElBQU0sT0FBTyxHQUFHLDBCQUFZLE9BQU8sQ0FBQyxDQUFDO0FBQ3JDLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDakMsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3RDLElBQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3RDLElBQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUM1QyxJQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDbEIsSUFBTSxpQkFBaUIsR0FBRyxFQUFFLENBQUM7QUFDN0IsSUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDNUIsSUFBTSxvQkFBb0IsR0FBRyxtQ0FBeUIsQ0FBQztBQUN2RCxJQUFJLENBQUMsWUFBQSxDQUFDOztBQUVOLElBQU0sa0JBQWtCLEdBQUcsQ0FDMUIsV0FBVyxFQUNYLFlBQVksRUFDWixlQUFlLENBQ2YsQ0FBQzs7QUFFRixJQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3ZELGVBQWUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGtCQUFrQixDQUFDLENBQUM7QUFDdkQsZUFBZSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7O0FBRTlDLElBQU0sZ0JBQWdCLEdBQUcsU0FBbkIsZ0JBQWdCLENBQUksSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUs7QUFDckQsZ0JBQWUsQ0FBQyxXQUFXLEdBQUcsSUFBSSxJQUFJLFNBQVMsSUFBSSxNQUFNLGVBQWEsSUFBSSxTQUFJLFNBQVMsU0FBSSxNQUFNLEdBQUssRUFBRSxDQUFDO0NBQ3pHLENBQUM7O0FBRUYsSUFBTSxtQkFBbUIsR0FBRyxTQUF0QixtQkFBbUIsR0FBUztBQUNqQyxLQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7O0FBRXBELEtBQUksTUFBTSxJQUFJLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRTtBQUMzQyxTQUFPLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztFQUNwQzs7QUFFRCxRQUFPLEVBQUUsQ0FBQztDQUNWLENBQUM7O0FBRUYsSUFBTSxrQkFBa0IsR0FBRyxTQUFyQixrQkFBa0IsR0FBUztBQUNoQyxLQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7O0FBRXBELEtBQUksTUFBTSxJQUFJLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRTtBQUMxQyxTQUFPLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztFQUNuQzs7QUFFRCxRQUFPLEVBQUUsQ0FBQztDQUNWLENBQUM7O0FBRUYsSUFBTSxrQkFBa0IsR0FBRyxTQUFyQixrQkFBa0IsQ0FBRyxHQUFHLEVBQUk7QUFDakMsS0FBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDOztBQUVwRCxLQUFJLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDdEUsbUJBQWlCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzVDLFNBQU8saUJBQWlCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0VBQ3pDO0NBQ0QsQ0FBQzs7QUFFRixJQUFNLGNBQWMsR0FBRyxTQUFqQixjQUFjLENBQUcsS0FBSyxFQUFJOztBQUUvQixLQUFNLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQzs7QUFFaEMsS0FBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQzs7QUFFckIsUUFBTyxHQUFHLENBQUM7Q0FDWCxDQUFDOztBQUVGLElBQU0sZUFBZSxHQUFHLFNBQWxCLGVBQWUsQ0FBRyxNQUFNLEVBQUk7QUFDakMscUJBQW9CLENBQUMsT0FBTyxFQUFFLENBQUM7O0FBRS9CLEtBQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFVBQUEsS0FBSztTQUFJLGNBQWMsQ0FBQyxLQUFLLENBQUM7RUFBQSxDQUFDLENBQUM7O0FBRTNELEtBQU0sVUFBVSxHQUFHLG1CQUFtQixFQUFFLENBQUM7QUFDekMsRUFBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLFVBQUEsR0FBRyxFQUFJO0FBQ2pDLE1BQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRTtBQUMzQixxQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztHQUN4QjtFQUNELENBQUMsQ0FBQztDQUNILENBQUM7O0FBRUYsSUFBTSxVQUFVLEdBQUcsU0FBYixVQUFVLENBQUksTUFBTSxFQUFFLEdBQUcsRUFBSztBQUNuQyxLQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7O0FBRXBELEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUU7QUFDbEMsbUJBQWlCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztFQUNsQzs7QUFFRCxrQkFBaUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDO0NBQzNDLENBQUM7O0FBRUYsSUFBTSxjQUFjLEdBQUcsU0FBakIsY0FBYyxDQUFHLEdBQUcsRUFBSTtBQUM3QixLQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7O0FBRXBELEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUU7QUFDbEMsU0FBTyxJQUFJLENBQUM7RUFDWjs7QUFFRCxRQUFPLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUN6QyxDQUFDOztBQUVGLElBQU0sZUFBZSxHQUFHLFNBQWxCLGVBQWUsR0FBUztBQUM3QixLQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDOztBQUVsRixLQUFJLENBQUMsU0FBUyxFQUFFO0FBQ2YsU0FBTztFQUNQOztBQUVELEtBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFO0FBQ2hDLFdBQVMsQ0FBQyxXQUFXLENBQUMsRUFBQyxJQUFJLEVBQUUsZUFBZSxFQUFDLENBQUMsQ0FBQztFQUMvQzs7QUFFRCxLQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7O0FBRXBELEtBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUU7QUFDNUMsa0JBQWdCLEVBQUUsQ0FBQztBQUNuQixTQUFPO0VBQ1A7O0FBRUQsS0FBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLHVCQUF1QixFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztBQUN0RCxLQUFJLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDakcsTUFBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzs7QUFFakIsaUJBQWdCLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztDQUM1RCxDQUFDOztBQUVGLElBQU0sa0JBQWtCLEdBQUcsU0FBckIsa0JBQWtCLENBQUcsS0FBSyxFQUFJO0FBQ25DLFFBQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsVUFBQSxFQUFFO1NBQU8sRUFBRSxDQUFDLFNBQVMsVUFBSyxFQUFFLENBQUMsTUFBTTtFQUFFLENBQUMsQ0FBQztDQUMzRCxDQUFDOztBQUVGLElBQU0sVUFBVSxHQUFHLFNBQWIsVUFBVSxDQUFJLE1BQU0sRUFBRSxLQUFLLEVBQUs7QUFDckMsS0FBTSxHQUFHLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2xDLEtBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO0FBQy9FLEtBQU0sT0FBTyxtQ0FBaUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFRLENBQUM7QUFDN0YsS0FBTSxNQUFNLEdBQUcsYUFBYSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0Isc0NBQW9DLEdBQUcsQ0FBRyxDQUFDO0FBQ25HLEtBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRTtBQUN6QyxPQUFLLEVBQUUsT0FBTztBQUNkLFdBQVMsRUFBRSxRQUFRO0FBQ25CLE9BQUssRUFBRSxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUM7RUFDbEIsQ0FBQyxDQUFDOztBQUVILHFCQUFvQixDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztDQUNsQyxDQUFDOztBQUVGLElBQU0sWUFBWSxHQUFHLFNBQWYsWUFBWSxDQUFHLEdBQUcsRUFBSTtBQUMzQixLQUFNLEdBQUcsR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRWhDLEtBQUksY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ3hCLFNBQU87RUFDUDs7QUFFRCxLQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDcEQsS0FBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM1RCxPQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxFQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsU0FBTyxhQUFhLEVBQUMsQ0FBQyxDQUFDO0FBQ3BFLE9BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEVBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxTQUFPLG9CQUFvQixFQUFDLENBQUMsQ0FBQztBQUNsRixXQUFVLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLFdBQVUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7Q0FDeEIsQ0FBQzs7QUFFRixJQUFNLGFBQWEsR0FBRyxTQUFoQixhQUFhLEdBQVM7QUFDM0IsS0FBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLENBQUM7QUFDL0MsZ0JBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN4QixnQkFBZSxFQUFFLENBQUM7QUFDbEIsRUFBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUM7Q0FDN0IsQ0FBQzs7QUFFRixJQUFNLHdCQUF3QixHQUFHLFNBQTNCLHdCQUF3QixDQUFHLEVBQUUsRUFBSTtBQUN0QyxLQUFJLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQzFCLFNBQU8saUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7RUFDN0I7Q0FDRCxDQUFDOztBQUVGLElBQU0sdUJBQXVCLEdBQUcsU0FBMUIsdUJBQXVCLENBQUcsRUFBRSxFQUFJO0FBQ3JDLEtBQUksZ0JBQWdCLENBQUMsRUFBRSxDQUFDLEVBQUU7QUFDekIsU0FBTyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztFQUM1QjtDQUNELENBQUM7O0FBRUYsSUFBTSxJQUFJLEdBQUcsU0FBUCxJQUFJLEdBQVM7QUFDbEIsS0FBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDOztBQUVwRCxLQUFJLENBQUMsTUFBTSxFQUFFO0FBQ1osU0FBTztFQUNQOztBQUVELEtBQUksa0JBQWtCLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtBQUNyRSxTQUFPO0VBQ1A7O0FBRUQsS0FBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDOzs7O0FBSTdCLFFBQU8sQ0FBQyxLQUFLLENBQUMsa0JBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7OztBQUdsQyxLQUFJLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBQyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUN0RCx5QkFBdUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDbkMsZUFBYSxFQUFFLENBQUM7QUFDaEIsMEJBQXdCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3BDLFNBQU87RUFDUDs7QUFFRCxLQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQzlDLEtBQU0sTUFBTSxHQUFHLEFBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxHQUFJLE9BQU8sRUFBRSxDQUFDLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUM7O0FBRTdJLEtBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEVBQUU7QUFDN0UsU0FBTztFQUNQOztBQUVELEtBQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNsQyxLQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDO0FBQ25ELEtBQU0sS0FBSyxHQUFHLFlBQVksS0FBSyxZQUFZLElBQUksWUFBWSxLQUFLLGVBQWUsQ0FBQztBQUNoRixLQUFNLElBQUksR0FBRyxLQUFLLEdBQUcsaUNBQWUsUUFBUSxDQUFDLEdBQUcsUUFBUSxDQUFDO0FBQ3pELEtBQU0sY0FBYyxHQUFHLElBQUksS0FBSyxRQUFRLENBQUM7O0FBRXpDLEtBQUk7QUFDSCxRQUFNLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7RUFDckMsQ0FBQyxPQUFPLEdBQUcsRUFBRSxFQUFFOztBQUVoQix3QkFBdUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7OztBQUduQyxLQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQzs7QUFFeEMsS0FBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs7O0FBRXRCLE9BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztBQUNmLElBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQUEsRUFBRSxFQUFJO0FBQ3BCLFFBQUksY0FBYyxFQUFFO0FBQ25CLE9BQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztLQUNWOztBQUVELFFBQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUM7O0FBRWxCLFFBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtBQUMxQixRQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDOztBQUVoQixRQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFBQSxFQUFFO2FBQUksRUFBRSxDQUFDLFNBQVM7TUFBQSxDQUFDLENBQUM7S0FDOUMsTUFBTTtBQUNOLFFBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2Q7SUFDRCxDQUFDLENBQUM7O0FBRUgsbUJBQWdCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQzs7RUFDbEM7O0FBRUQsY0FBYSxFQUFFLENBQUM7Q0FDaEIsQ0FBQzs7QUFFRixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7QUFDekIsSUFBSSxzQkFBc0IsR0FBRyxJQUFJLENBQUM7QUFDbEMsSUFBSSx3QkFBd0IsR0FBRyxJQUFJLENBQUM7O0FBRXBDLElBQU0sY0FBYyxHQUFHLFNBQWpCLGNBQWMsR0FBUztBQUM1QixLQUFJLEVBQUUsQ0FBQztBQUNQLEtBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDOztBQUU1RCxjQUFhLEdBQUcsYUFBYSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ3RELHVCQUFzQixHQUFHLHNCQUFzQixJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ2xGLHlCQUF3QixHQUFHLHdCQUF3QixJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxDQUFDOztBQUV4RixLQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLFVBQUEsTUFBTSxFQUFJO0FBQzNDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQzs7QUFFbEMsUUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztBQUNqRSxRQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO0FBQzNFLFFBQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixFQUFFLGFBQWEsQ0FBQyxDQUFDOztBQUVsRSxNQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsRUFBRTtBQUNsRCxTQUFNLENBQUMsbUJBQW1CLENBQUMsYUFBYSxDQUFDLENBQUM7R0FDMUM7O0FBRUQsUUFBTSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQzs7QUFFaEMsUUFBTSxDQUFDLG9CQUFvQixDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDcEQsUUFBTSxDQUFDLHlCQUF5QixDQUFDLHdCQUF3QixDQUFDLENBQUM7RUFDM0QsQ0FBQyxDQUFDOztBQUVILGlCQUFnQixDQUFDLGdCQUFnQixDQUFDLHdCQUF3QixFQUFFLFVBQUMsQ0FBQyxFQUFFLFVBQVUsRUFBSztBQUM5RSxNQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxFQUFFO0FBQ3BDLDBCQUF1QixDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDOUMsMkJBQXdCLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztHQUMvQztFQUNELENBQUMsQ0FBQztDQUNILENBQUM7O0FBRUssSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sR0FBRztBQUNyQyxXQUFVLEVBQUU7QUFDWCxNQUFJLEVBQUUsU0FBUztBQUNmLGFBQVMsS0FBSztBQUNkLGFBQVcsRUFBRSxpRUFBaUU7RUFDOUU7QUFDRCxtQkFBa0IsRUFBRTtBQUNuQixNQUFJLEVBQUUsU0FBUztBQUNmLGFBQVMsS0FBSztFQUNkO0FBQ0Qsa0JBQWlCLEVBQUU7QUFDbEIsTUFBSSxFQUFFLFNBQVM7QUFDZixhQUFTLEtBQUs7QUFDZCxPQUFLLEVBQUUscUJBQXFCO0VBQzVCO0NBQ0QsQ0FBQzs7O0FBRUssSUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsR0FBRyxZQUFNO0FBQy9DLEVBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUNiLGVBQWMsRUFBRSxDQUFDO0FBQ2pCLEtBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQ3pELEtBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLDJCQUEyQixFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQ2pFLEtBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztDQUN6RCxDQUFDOzs7cUJBRWEsTUFBTSIsImZpbGUiOiIvaG9tZS9hbmRyZWkvLmF0b20vcGFja2FnZXMvanNoaW50L2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGV9IGZyb20gJ2V2ZW50LWtpdCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCByZWFjdERvbVByYWdtYSBmcm9tICdyZWFjdC1kb20tcHJhZ21hJztcbmltcG9ydCBsYXp5UmVxdWlyZSBmcm9tICdsYXp5LXJlcSc7XG5cbmNvbnN0IGxhenlSZXEgPSBsYXp5UmVxdWlyZShyZXF1aXJlKTtcbmNvbnN0IGxvZGFzaCA9IGxhenlSZXEoJ2xvZGFzaCcpO1xuY29uc3QganNoaW50ID0gbGF6eVJlcSgnanNoaW50Jyk7XG5jb25zdCBqc3hoaW50ID0gbGF6eVJlcSgnanNoaW50LWpzeCcpO1xuY29uc3QgY2xpID0gbGF6eVJlcSgnanNoaW50L3NyYy9jbGknKTtcbmNvbnN0IGxvYWRDb25maWcgPSBsYXp5UmVxKCcuL2xvYWQtY29uZmlnJyk7XG5jb25zdCBwbHVnaW4gPSB7fTtcbmNvbnN0IG1hcmtlcnNCeUVkaXRvcklkID0ge307XG5jb25zdCBlcnJvcnNCeUVkaXRvcklkID0ge307XG5jb25zdCBzdWJzY3JpcHRpb25Ub29sdGlwcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5sZXQgXztcblxuY29uc3QgU1VQUE9SVEVEX0dSQU1NQVJTID0gW1xuXHQnc291cmNlLmpzJyxcblx0J3NvdXJjZS5qc3gnLFxuXHQnc291cmNlLmpzLmpzeCdcbl07XG5cbmNvbnN0IGpzSGludFN0YXR1c0JhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbmpzSGludFN0YXR1c0Jhci5zZXRBdHRyaWJ1dGUoJ2lkJywgJ2pzaGludC1zdGF0dXNiYXInKTtcbmpzSGludFN0YXR1c0Jhci5jbGFzc0xpc3QuYWRkKCdpbmxpbmUtYmxvY2snKTtcblxuY29uc3QgdXBkYXRlU3RhdHVzVGV4dCA9IChsaW5lLCBjaGFyYWN0ZXIsIHJlYXNvbikgPT4ge1xuXHRqc0hpbnRTdGF0dXNCYXIudGV4dENvbnRlbnQgPSBsaW5lICYmIGNoYXJhY3RlciAmJiByZWFzb24gPyBgSlNIaW50ICR7bGluZX06JHtjaGFyYWN0ZXJ9ICR7cmVhc29ufWAgOiAnJztcbn07XG5cbmNvbnN0IGdldE1hcmtlcnNGb3JFZGl0b3IgPSAoKSA9PiB7XG5cdGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAoZWRpdG9yICYmIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0pIHtcblx0XHRyZXR1cm4gbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXTtcblx0fVxuXG5cdHJldHVybiB7fTtcbn07XG5cbmNvbnN0IGdldEVycm9yc0ZvckVkaXRvciA9ICgpID0+IHtcblx0Y29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmIChlZGl0b3IgJiYgZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSB7XG5cdFx0cmV0dXJuIGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXTtcblx0fVxuXG5cdHJldHVybiBbXTtcbn07XG5cbmNvbnN0IGRlc3Ryb3lNYXJrZXJBdFJvdyA9IHJvdyA9PiB7XG5cdGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAobWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSAmJiBtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdW3Jvd10pIHtcblx0XHRtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdW3Jvd10uZGVzdHJveSgpO1xuXHRcdGRlbGV0ZSBtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdW3Jvd107XG5cdH1cbn07XG5cbmNvbnN0IGdldFJvd0ZvckVycm9yID0gZXJyb3IgPT4ge1xuXHQvLyBKU0hpbnQgcmVwb3J0cyBgbGluZTogMGAgd2hlbiBjb25maWcgZXJyb3Jcblx0Y29uc3QgbGluZSA9IGVycm9yWzBdLmxpbmUgfHwgMTtcblxuXHRjb25zdCByb3cgPSBsaW5lIC0gMTtcblxuXHRyZXR1cm4gcm93O1xufTtcblxuY29uc3QgY2xlYXJPbGRNYXJrZXJzID0gZXJyb3JzID0+IHtcblx0c3Vic2NyaXB0aW9uVG9vbHRpcHMuZGlzcG9zZSgpO1xuXG5cdGNvbnN0IHJvd3MgPSBfLm1hcChlcnJvcnMsIGVycm9yID0+IGdldFJvd0ZvckVycm9yKGVycm9yKSk7XG5cblx0Y29uc3Qgb2xkTWFya2VycyA9IGdldE1hcmtlcnNGb3JFZGl0b3IoKTtcblx0Xy5lYWNoKF8ua2V5cyhvbGRNYXJrZXJzKSwgcm93ID0+IHtcblx0XHRpZiAoIV8uY29udGFpbnMocm93cywgcm93KSkge1xuXHRcdFx0ZGVzdHJveU1hcmtlckF0Um93KHJvdyk7XG5cdFx0fVxuXHR9KTtcbn07XG5cbmNvbnN0IHNhdmVNYXJrZXIgPSAobWFya2VyLCByb3cpID0+IHtcblx0Y29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmICghbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0gPSB7fTtcblx0fVxuXG5cdG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XSA9IG1hcmtlcjtcbn07XG5cbmNvbnN0IGdldE1hcmtlckF0Um93ID0gcm93ID0+IHtcblx0Y29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmICghbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdHJldHVybiBudWxsO1xuXHR9XG5cblx0cmV0dXJuIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XTtcbn07XG5cbmNvbnN0IHVwZGF0ZVN0YXR1c2JhciA9ICgpID0+IHtcblx0Y29uc3Qgc3RhdHVzQmFyID0gYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKS5xdWVyeVNlbGVjdG9yKCcuc3RhdHVzLWJhcicpO1xuXG5cdGlmICghc3RhdHVzQmFyKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0aWYgKCFqc0hpbnRTdGF0dXNCYXIucGFyZW50Tm9kZSkge1xuXHRcdHN0YXR1c0Jhci5hZGRMZWZ0VGlsZSh7aXRlbToganNIaW50U3RhdHVzQmFyfSk7XG5cdH1cblxuXHRjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cblx0aWYgKCFlZGl0b3IgfHwgIWVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdHVwZGF0ZVN0YXR1c1RleHQoKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRjb25zdCBsaW5lID0gZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkucm93ICsgMTtcblx0bGV0IGVycm9yID0gZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdW2xpbmVdIHx8IF8uZmlyc3QoXy5jb21wYWN0KGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkpO1xuXHRlcnJvciA9IGVycm9yWzBdO1xuXG5cdHVwZGF0ZVN0YXR1c1RleHQoZXJyb3IubGluZSwgZXJyb3IuY2hhcmFjdGVyLCBlcnJvci5yZWFzb24pO1xufTtcblxuY29uc3QgZ2V0UmVhc29uc0ZvckVycm9yID0gZXJyb3IgPT4ge1xuXHRyZXR1cm4gXy5tYXAoZXJyb3IsIGVsID0+IGAke2VsLmNoYXJhY3Rlcn06ICR7ZWwucmVhc29ufWApO1xufTtcblxuY29uc3QgYWRkUmVhc29ucyA9IChtYXJrZXIsIGVycm9yKSA9PiB7XG5cdGNvbnN0IHJvdyA9IGdldFJvd0ZvckVycm9yKGVycm9yKTtcblx0Y29uc3QgZWRpdG9yRWxlbWVudCA9IGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkpO1xuXHRjb25zdCByZWFzb25zID0gYDxkaXYgY2xhc3M9XCJqc2hpbnQtZXJyb3JzXCI+JHtnZXRSZWFzb25zRm9yRXJyb3IoZXJyb3IpLmpvaW4oJzxicj4nKX08L2Rpdj5gO1xuXHRjb25zdCB0YXJnZXQgPSBlZGl0b3JFbGVtZW50LnNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvckFsbChgLmpzaGludC1saW5lLW51bWJlci5saW5lLW51bWJlci0ke3Jvd31gKTtcblx0Y29uc3QgdG9vbHRpcCA9IGF0b20udG9vbHRpcHMuYWRkKHRhcmdldCwge1xuXHRcdHRpdGxlOiByZWFzb25zLFxuXHRcdHBsYWNlbWVudDogJ2JvdHRvbScsXG5cdFx0ZGVsYXk6IHtzaG93OiAyMDB9XG5cdH0pO1xuXG5cdHN1YnNjcmlwdGlvblRvb2x0aXBzLmFkZCh0b29sdGlwKTtcbn07XG5cbmNvbnN0IGRpc3BsYXlFcnJvciA9IGVyciA9PiB7XG5cdGNvbnN0IHJvdyA9IGdldFJvd0ZvckVycm9yKGVycik7XG5cblx0aWYgKGdldE1hcmtlckF0Um93KHJvdykpIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cdGNvbnN0IG1hcmtlciA9IGVkaXRvci5tYXJrQnVmZmVyUmFuZ2UoW1tyb3csIDBdLCBbcm93LCAxXV0pO1xuXHRlZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7dHlwZTogJ2xpbmUnLCBjbGFzczogJ2pzaGludC1saW5lJ30pO1xuXHRlZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7dHlwZTogJ2xpbmUtbnVtYmVyJywgY2xhc3M6ICdqc2hpbnQtbGluZS1udW1iZXInfSk7XG5cdHNhdmVNYXJrZXIobWFya2VyLCByb3cpO1xuXHRhZGRSZWFzb25zKG1hcmtlciwgZXJyKTtcbn07XG5cbmNvbnN0IGRpc3BsYXlFcnJvcnMgPSAoKSA9PiB7XG5cdGNvbnN0IGVycm9ycyA9IF8uY29tcGFjdChnZXRFcnJvcnNGb3JFZGl0b3IoKSk7XG5cdGNsZWFyT2xkTWFya2VycyhlcnJvcnMpO1xuXHR1cGRhdGVTdGF0dXNiYXIoKTtcblx0Xy5lYWNoKGVycm9ycywgZGlzcGxheUVycm9yKTtcbn07XG5cbmNvbnN0IHJlbW92ZU1hcmtlcnNGb3JFZGl0b3JJZCA9IGlkID0+IHtcblx0aWYgKG1hcmtlcnNCeUVkaXRvcklkW2lkXSkge1xuXHRcdGRlbGV0ZSBtYXJrZXJzQnlFZGl0b3JJZFtpZF07XG5cdH1cbn07XG5cbmNvbnN0IHJlbW92ZUVycm9yc0ZvckVkaXRvcklkID0gaWQgPT4ge1xuXHRpZiAoZXJyb3JzQnlFZGl0b3JJZFtpZF0pIHtcblx0XHRkZWxldGUgZXJyb3JzQnlFZGl0b3JJZFtpZF07XG5cdH1cbn07XG5cbmNvbnN0IGxpbnQgPSAoKSA9PiB7XG5cdGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAoIWVkaXRvcikge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGlmIChTVVBQT1JURURfR1JBTU1BUlMuaW5kZXhPZihlZGl0b3IuZ2V0R3JhbW1hcigpLnNjb3BlTmFtZSkgPT09IC0xKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0Y29uc3QgZmlsZSA9IGVkaXRvci5nZXRVUkkoKTtcblxuXHQvLyBIYWNrIHRvIG1ha2UgSlNIaW50IGxvb2sgZm9yIC5qc2hpbnRpZ25vcmUgaW4gdGhlIGNvcnJlY3QgZGlyXG5cdC8vIEJlY2F1c2UgSlNIaW50IGRvZXNuJ3QgdXNlIGl0cyBgY3dkYCBvcHRpb25cblx0cHJvY2Vzcy5jaGRpcihwYXRoLmRpcm5hbWUoZmlsZSkpO1xuXG5cdC8vIFJlbW92ZSBlcnJvcnMgYW5kIGRvbid0IGxpbnQgaWYgZmlsZSBpcyBpZ25vcmVkIGluIC5qc2hpbnRpZ25vcmVcblx0aWYgKGZpbGUgJiYgY2xpKCkuZ2F0aGVyKHthcmdzOiBbZmlsZV19KS5sZW5ndGggPT09IDApIHtcblx0XHRyZW1vdmVFcnJvcnNGb3JFZGl0b3JJZChlZGl0b3IuaWQpO1xuXHRcdGRpc3BsYXlFcnJvcnMoKTtcblx0XHRyZW1vdmVNYXJrZXJzRm9yRWRpdG9ySWQoZWRpdG9yLmlkKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRjb25zdCBjb25maWcgPSBmaWxlID8gbG9hZENvbmZpZygpKGZpbGUpIDoge307XG5cdGNvbnN0IGxpbnRlciA9IChhdG9tLmNvbmZpZy5nZXQoJ2pzaGludC5zdXBwb3J0TGludGluZ0pzeCcpIHx8IGF0b20uY29uZmlnLmdldCgnanNoaW50LnRyYW5zZm9ybUpzeCcpKSA/IGpzeGhpbnQoKS5KU1hISU5UIDoganNoaW50KCkuSlNISU5UO1xuXG5cdGlmIChPYmplY3Qua2V5cyhjb25maWcpLmxlbmd0aCA9PT0gMCAmJiBhdG9tLmNvbmZpZy5nZXQoJ2pzaGludC5vbmx5Q29uZmlnJykpIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRjb25zdCBvcmlnQ29kZSA9IGVkaXRvci5nZXRUZXh0KCk7XG5cdGNvbnN0IGdyYW1tYXJTY29wZSA9IGVkaXRvci5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lO1xuXHRjb25zdCBpc0pzeCA9IGdyYW1tYXJTY29wZSA9PT0gJ3NvdXJjZS5qc3gnIHx8IGdyYW1tYXJTY29wZSA9PT0gJ3NvdXJjZS5qcy5qc3gnO1xuXHRjb25zdCBjb2RlID0gaXNKc3ggPyByZWFjdERvbVByYWdtYShvcmlnQ29kZSkgOiBvcmlnQ29kZTtcblx0Y29uc3QgcHJhZ21hV2FzQWRkZWQgPSBjb2RlICE9PSBvcmlnQ29kZTtcblxuXHR0cnkge1xuXHRcdGxpbnRlcihjb2RlLCBjb25maWcsIGNvbmZpZy5nbG9iYWxzKTtcblx0fSBjYXRjaCAoZXJyKSB7fVxuXG5cdHJlbW92ZUVycm9yc0ZvckVkaXRvcklkKGVkaXRvci5pZCk7XG5cblx0Ly8gd29ya2Fyb3VuZCB0aGUgZXJyb3JzIGFycmF5IHNvbWV0aW1lcyBjb250YWluaW5nIGBudWxsYFxuXHRjb25zdCBlcnJvcnMgPSBfLmNvbXBhY3QobGludGVyLmVycm9ycyk7XG5cblx0aWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG5cdFx0Ly8gYWdncmVnYXRlIHNhbWUtbGluZSBlcnJvcnNcblx0XHRjb25zdCByZXQgPSBbXTtcblx0XHRfLmVhY2goZXJyb3JzLCBlbCA9PiB7XG5cdFx0XHRpZiAocHJhZ21hV2FzQWRkZWQpIHtcblx0XHRcdFx0ZWwubGluZS0tO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBsID0gZWwubGluZTtcblxuXHRcdFx0aWYgKEFycmF5LmlzQXJyYXkocmV0W2xdKSkge1xuXHRcdFx0XHRyZXRbbF0ucHVzaChlbCk7XG5cblx0XHRcdFx0cmV0W2xdID0gXy5zb3J0QnkocmV0W2xdLCBlbCA9PiBlbC5jaGFyYWN0ZXIpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0cmV0W2xdID0gW2VsXTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSA9IHJldDtcblx0fVxuXG5cdGRpc3BsYXlFcnJvcnMoKTtcbn07XG5cbmxldCBkZWJvdW5jZWRMaW50ID0gbnVsbDtcbmxldCBkZWJvdW5jZWREaXNwbGF5RXJyb3JzID0gbnVsbDtcbmxldCBkZWJvdW5jZWRVcGRhdGVTdGF0dXNiYXIgPSBudWxsO1xuXG5jb25zdCByZWdpc3RlckV2ZW50cyA9ICgpID0+IHtcblx0bGludCgpO1xuXHRjb25zdCB3b3Jrc3BhY2VFbGVtZW50ID0gYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKTtcblxuXHRkZWJvdW5jZWRMaW50ID0gZGVib3VuY2VkTGludCB8fCBfLmRlYm91bmNlKGxpbnQsIDUwKTtcblx0ZGVib3VuY2VkRGlzcGxheUVycm9ycyA9IGRlYm91bmNlZERpc3BsYXlFcnJvcnMgfHwgXy5kZWJvdW5jZShkaXNwbGF5RXJyb3JzLCAyMDApO1xuXHRkZWJvdW5jZWRVcGRhdGVTdGF0dXNiYXIgPSBkZWJvdW5jZWRVcGRhdGVTdGF0dXNiYXIgfHwgXy5kZWJvdW5jZSh1cGRhdGVTdGF0dXNiYXIsIDEwMCk7XG5cblx0YXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKGVkaXRvciA9PiB7XG5cdFx0Y29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuXG5cdFx0ZWRpdG9yLmVtaXR0ZXIub2ZmKCdzY3JvbGwtdG9wLWNoYW5nZWQnLCBkZWJvdW5jZWREaXNwbGF5RXJyb3JzKTtcblx0XHRlZGl0b3IuZW1pdHRlci5vZmYoJ2RpZC1jaGFuZ2UtY3Vyc29yLXBvc2l0aW9uJywgZGVib3VuY2VkVXBkYXRlU3RhdHVzYmFyKTtcblx0XHRidWZmZXIuZW1pdHRlci5vZmYoJ2RpZC1zYXZlIGRpZC1jaGFuZ2UtbW9kaWZpZWQnLCBkZWJvdW5jZWRMaW50KTtcblxuXHRcdGlmICghYXRvbS5jb25maWcuZ2V0KCdqc2hpbnQudmFsaWRhdGVPbmx5T25TYXZlJykpIHtcblx0XHRcdGJ1ZmZlci5vbkRpZENoYW5nZU1vZGlmaWVkKGRlYm91bmNlZExpbnQpO1xuXHRcdH1cblxuXHRcdGJ1ZmZlci5vbkRpZFNhdmUoZGVib3VuY2VkTGludCk7XG5cblx0XHRlZGl0b3Iub25EaWRDaGFuZ2VTY3JvbGxUb3AoZGVib3VuY2VkRGlzcGxheUVycm9ycyk7XG5cdFx0ZWRpdG9yLm9uRGlkQ2hhbmdlQ3Vyc29yUG9zaXRpb24oZGVib3VuY2VkVXBkYXRlU3RhdHVzYmFyKTtcblx0fSk7XG5cblx0d29ya3NwYWNlRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdlZGl0b3I6d2lsbC1iZS1yZW1vdmVkJywgKGUsIGVkaXRvclZpZXcpID0+IHtcblx0XHRpZiAoZWRpdG9yVmlldyAmJiBlZGl0b3JWaWV3LmVkaXRvcikge1xuXHRcdFx0cmVtb3ZlRXJyb3JzRm9yRWRpdG9ySWQoZWRpdG9yVmlldy5lZGl0b3IuaWQpO1xuXHRcdFx0cmVtb3ZlTWFya2Vyc0ZvckVkaXRvcklkKGVkaXRvclZpZXcuZWRpdG9yLmlkKTtcblx0XHR9XG5cdH0pO1xufTtcblxuZXhwb3J0IGNvbnN0IGNvbmZpZyA9IHBsdWdpbi5jb25maWcgPSB7XG5cdG9ubHlDb25maWc6IHtcblx0XHR0eXBlOiAnYm9vbGVhbicsXG5cdFx0ZGVmYXVsdDogZmFsc2UsXG5cdFx0ZGVzY3JpcHRpb246ICdEaXNhYmxlIGxpbnRlciBpZiB0aGVyZSBpcyBubyBjb25maWcgZmlsZSBmb3VuZCBmb3IgdGhlIGxpbnRlci4nXG5cdH0sXG5cdHZhbGlkYXRlT25seU9uU2F2ZToge1xuXHRcdHR5cGU6ICdib29sZWFuJyxcblx0XHRkZWZhdWx0OiBmYWxzZVxuXHR9LFxuXHRzdXBwb3J0TGludGluZ0pzeDoge1xuXHRcdHR5cGU6ICdib29sZWFuJyxcblx0XHRkZWZhdWx0OiBmYWxzZSxcblx0XHR0aXRsZTogJ1N1cHBvcnQgTGludGluZyBKU1gnXG5cdH1cbn07XG5cbmV4cG9ydCBjb25zdCBhY3RpdmF0ZSA9IHBsdWdpbi5hY3RpdmF0ZSA9ICgpID0+IHtcblx0XyA9IGxvZGFzaCgpO1xuXHRyZWdpc3RlckV2ZW50cygpO1xuXHRhdG9tLmNvbmZpZy5vYnNlcnZlKCdqc2hpbnQub25seUNvbmZpZycsIHJlZ2lzdGVyRXZlbnRzKTtcblx0YXRvbS5jb25maWcub2JzZXJ2ZSgnanNoaW50LnZhbGlkYXRlT25seU9uU2F2ZScsIHJlZ2lzdGVyRXZlbnRzKTtcblx0YXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywgJ2pzaGludDpsaW50JywgbGludCk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBwbHVnaW47XG4iXX0=