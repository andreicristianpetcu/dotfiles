var exec = require('child_process').exec;

module.exports = {
    config: {
        enabled: {
            type: 'boolean',
            'default': true
        }
    },

    /**
     * Activates the package.
     */
    activate: function activate() {
        atom.commands.add('atom-workspace', 'gtk-dark-theme:enable', this.enable);
        atom.commands.add('atom-workspace', 'gtk-dark-theme:disable', this.disable);

        // Automatically enable dark theme if it was enabled last time we ran.
        if (atom.config.get('gtk-dark-theme.enabled')) {
            this.enable();
        }
    },

    /**
     * Enables the GTK dark theme.
     */
    enable: function enable() {
        console.log('Setting GTK theme variant to "dark".');
        setAtomGtkTheme('dark').then(function () {
            atom.config.set('gtk-dark-theme.enabled', true);
        });
    },

    /**
     * Disables the GTK dark theme.
     */
    disable: function disable() {
        console.log('Setting GTK theme variant to "light".');
        setAtomGtkTheme('light').then(function () {
            atom.config.set('gtk-dark-theme.enabled', false);
        });
    }
};

/**
 * Gets the PIDs of all running Atom processes.
 *
 * @return Promise
 */
function getAtomProcessIds() {
    return new Promise(function (resolve, reject) {
        exec('pidof atom', function (error, stdout, stderr) {
            if (error) {
                return reject(error);
            }

            // Get all PIDs for Atom processes.
            var pids = stdout.trim().split(' ').map(parseFloat);
            resolve(pids);
        });
    });
}

/**
 * Gets the handle IDs of all currently open Atom windows.
 *
 * @return Promise
 */
function getAtomWindowHandles() {
    // First, get all of the open windows and their respective process IDs.
    var windowPids = getAllWindowHandles().then(function (windowHandles) {
        var promises = [];

        // Go through each handle and fetch its owner process ID.
        for (var i = 0; i < windowHandles.length; i++) {
            var handle = windowHandles[i];
            promises.push(getWindowProcessId(handle).then(function (pid) {
                return {
                    handle: handle,
                    pid: pid
                };
            }, function (reason) {}));
        }

        return Promise.all(promises);
    });

    // Now, get all of Atom's processes and match the window handles to see if
    // they belong to Atom.
    var pids = getAtomProcessIds();
    return Promise.all([pids, windowPids]).then(function (values) {
        var handles = [];

        // For each window handle, if the window's PID is in the list of Atom
        // PIDs, add the window's handle to the list.
        for (var i = 0; i < values[1].length; i++) {
            if (values[1][i] && values[0].indexOf(values[1][i].pid) > -1) {
                handles.push(values[1][i].handle);
            }
        }

        return handles;
    });
}

/**
 * Sets the GTK theme variant of all Atom windows.
 *
 * @param [String] variant The GTK theme variant to set.
 *
 * @return Promise
 */
function setAtomGtkTheme(theme) {
    return getAtomWindowHandles().then(function (handles) {
        var promises = [];

        for (var i = 0; i < handles.length; i++) {
            var cmd = 'xprop -id ' + handles[i] + ' -f _GTK_THEME_VARIANT 8u -set _GTK_THEME_VARIANT ' + theme;

            promises.push(new Promise(function (resolve, reject) {
                exec(cmd, function (error, stdout, stderr) {
                    if (error) {
                        reject(error);
                    } else {
                        resolve();
                    }
                });
            }));
        }

        return Promise.all(promises);
    });
}

/**
 * Gets the window handle IDs of all windows currently open.
 *
 * @return Promise
 */
function getAllWindowHandles() {
    return new Promise(function (resolve, reject) {
        exec('xprop -root _NET_CLIENT_LIST', function (error, stdout, stderr) {
            if (error) {
                return reject(error);
            }

            var ids = stdout.match(/0x(([a-z]|\d)+)/gi);
            resolve(ids);
        });
    });
}

/**
 * Gets the PID of the process that owns a window handle ID.
 *
 * @param [String] handle The window handle ID.
 *
 * @return Promise
 */
function getWindowProcessId(handle) {
    return new Promise(function (resolve, reject) {
        exec('xprop -id ' + handle + ' _NET_WM_PID', function (error, stdout, stderr) {
            if (error || stdout.indexOf('_NET_WM_PID(CARDINAL)') == -1) {
                return reject(error);
            }

            var pid = parseFloat(stdout.match(/\d+/)[0]);
            resolve(pid);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2FuZHJlaS8uYXRvbS9wYWNrYWdlcy9ndGstZGFyay10aGVtZS9saWIvZ3RrLWRhcmstdGhlbWUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQzs7QUFFekMsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNiLFVBQU0sRUFBRTtBQUNKLGVBQU8sRUFBRTtBQUNMLGdCQUFJLEVBQUUsU0FBUztBQUNmLHVCQUFTLElBQUk7U0FDaEI7S0FDSjs7Ozs7QUFLRCxZQUFRLEVBQUUsb0JBQVc7QUFDakIsWUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzFFLFlBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLHdCQUF3QixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzs7O0FBRzVFLFlBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsRUFBRTtBQUMzQyxnQkFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2pCO0tBQ0o7Ozs7O0FBS0QsVUFBTSxFQUFFLGtCQUFXO0FBQ2YsZUFBTyxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0FBQ3BELHVCQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVk7QUFDckMsZ0JBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHdCQUF3QixFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ25ELENBQUMsQ0FBQztLQUNOOzs7OztBQUtELFdBQU8sRUFBRSxtQkFBVztBQUNoQixlQUFPLENBQUMsR0FBRyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7QUFDckQsdUJBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWTtBQUN0QyxnQkFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDcEQsQ0FBQyxDQUFDO0tBQ047Q0FDSixDQUFDOzs7Ozs7O0FBUUYsU0FBUyxpQkFBaUIsR0FBRztBQUN6QixXQUFPLElBQUksT0FBTyxDQUFDLFVBQVMsT0FBTyxFQUFFLE1BQU0sRUFBRTtBQUN6QyxZQUFJLENBQUMsWUFBWSxFQUFFLFVBQVMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDL0MsZ0JBQUksS0FBSyxFQUFFO0FBQ1AsdUJBQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3hCOzs7QUFHRCxnQkFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEQsbUJBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQixDQUFDLENBQUM7S0FDTixDQUFDLENBQUM7Q0FDTjs7Ozs7OztBQU9ELFNBQVMsb0JBQW9CLEdBQUc7O0FBRTVCLFFBQUksVUFBVSxHQUFHLG1CQUFtQixFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsYUFBYSxFQUFFO0FBQ2pFLFlBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQzs7O0FBR2xCLGFBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQzNDLGdCQUFJLE1BQU0sR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsb0JBQVEsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ3hELHVCQUFPO0FBQ0gsMEJBQU0sRUFBRSxNQUFNO0FBQ2QsdUJBQUcsRUFBRSxHQUFHO2lCQUNYLENBQUM7YUFDTCxFQUFFLFVBQVUsTUFBTSxFQUFFLEVBQ3BCLENBQUMsQ0FBQyxDQUFDO1NBQ1A7O0FBRUQsZUFBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ2hDLENBQUMsQ0FBQzs7OztBQUlILFFBQUksSUFBSSxHQUFHLGlCQUFpQixFQUFFLENBQUM7QUFDL0IsV0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsTUFBTSxFQUFFO0FBQzFELFlBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQzs7OztBQUlqQixhQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUN2QyxnQkFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7QUFDMUQsdUJBQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3JDO1NBQ0o7O0FBRUQsZUFBTyxPQUFPLENBQUM7S0FDbEIsQ0FBQyxDQUFDO0NBQ047Ozs7Ozs7OztBQVNELFNBQVMsZUFBZSxDQUFDLEtBQUssRUFBRTtBQUM1QixXQUFPLG9CQUFvQixFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVMsT0FBTyxFQUFFO0FBQ2pELFlBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQzs7QUFFbEIsYUFBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDckMsZ0JBQUksR0FBRyxHQUFHLFlBQVksR0FDaEIsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUNWLG9EQUFvRCxHQUNwRCxLQUFLLENBQUM7O0FBRVosb0JBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBUyxPQUFPLEVBQUUsTUFBTSxFQUFFO0FBQ2hELG9CQUFJLENBQUMsR0FBRyxFQUFFLFVBQVMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDdEMsd0JBQUksS0FBSyxFQUFFO0FBQ1AsOEJBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztxQkFDakIsTUFBTTtBQUNILCtCQUFPLEVBQUUsQ0FBQztxQkFDYjtpQkFDSixDQUFDLENBQUM7YUFDTixDQUFDLENBQUMsQ0FBQztTQUNQOztBQUVELGVBQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNoQyxDQUFDLENBQUM7Q0FDTjs7Ozs7OztBQU9ELFNBQVMsbUJBQW1CLEdBQUc7QUFDM0IsV0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFTLE9BQU8sRUFBRSxNQUFNLEVBQUU7QUFDekMsWUFBSSxDQUFDLDhCQUE4QixFQUFFLFVBQVMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDakUsZ0JBQUksS0FBSyxFQUFFO0FBQ1AsdUJBQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3hCOztBQUVELGdCQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDNUMsbUJBQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNoQixDQUFDLENBQUM7S0FDTixDQUFDLENBQUM7Q0FDTjs7Ozs7Ozs7O0FBU0QsU0FBUyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUU7QUFDaEMsV0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFTLE9BQU8sRUFBRSxNQUFNLEVBQUU7QUFDekMsWUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLEdBQUcsY0FBYyxFQUFFLFVBQVMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDekUsZ0JBQUksS0FBSyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtBQUN4RCx1QkFBTyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDeEI7O0FBRUQsZ0JBQUksR0FBRyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDN0MsbUJBQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNoQixDQUFDLENBQUM7S0FDTixDQUFDLENBQUM7Q0FDTiIsImZpbGUiOiIvaG9tZS9hbmRyZWkvLmF0b20vcGFja2FnZXMvZ3RrLWRhcmstdGhlbWUvbGliL2d0ay1kYXJrLXRoZW1lLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGV4ZWMgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlYztcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgY29uZmlnOiB7XG4gICAgICAgIGVuYWJsZWQ6IHtcbiAgICAgICAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgICAgICAgIGRlZmF1bHQ6IHRydWVcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBBY3RpdmF0ZXMgdGhlIHBhY2thZ2UuXG4gICAgICovXG4gICAgYWN0aXZhdGU6IGZ1bmN0aW9uKCkge1xuICAgICAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCAnZ3RrLWRhcmstdGhlbWU6ZW5hYmxlJywgdGhpcy5lbmFibGUpO1xuICAgICAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCAnZ3RrLWRhcmstdGhlbWU6ZGlzYWJsZScsIHRoaXMuZGlzYWJsZSk7XG5cbiAgICAgICAgLy8gQXV0b21hdGljYWxseSBlbmFibGUgZGFyayB0aGVtZSBpZiBpdCB3YXMgZW5hYmxlZCBsYXN0IHRpbWUgd2UgcmFuLlxuICAgICAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdndGstZGFyay10aGVtZS5lbmFibGVkJykpIHtcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRW5hYmxlcyB0aGUgR1RLIGRhcmsgdGhlbWUuXG4gICAgICovXG4gICAgZW5hYmxlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1NldHRpbmcgR1RLIHRoZW1lIHZhcmlhbnQgdG8gXCJkYXJrXCIuJyk7XG4gICAgICAgIHNldEF0b21HdGtUaGVtZSgnZGFyaycpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgYXRvbS5jb25maWcuc2V0KCdndGstZGFyay10aGVtZS5lbmFibGVkJywgdHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBEaXNhYmxlcyB0aGUgR1RLIGRhcmsgdGhlbWUuXG4gICAgICovXG4gICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdTZXR0aW5nIEdUSyB0aGVtZSB2YXJpYW50IHRvIFwibGlnaHRcIi4nKTtcbiAgICAgICAgc2V0QXRvbUd0a1RoZW1lKCdsaWdodCcpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgYXRvbS5jb25maWcuc2V0KCdndGstZGFyay10aGVtZS5lbmFibGVkJywgZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuXG5cbi8qKlxuICogR2V0cyB0aGUgUElEcyBvZiBhbGwgcnVubmluZyBBdG9tIHByb2Nlc3Nlcy5cbiAqXG4gKiBAcmV0dXJuIFByb21pc2VcbiAqL1xuZnVuY3Rpb24gZ2V0QXRvbVByb2Nlc3NJZHMoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBleGVjKCdwaWRvZiBhdG9tJywgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gR2V0IGFsbCBQSURzIGZvciBBdG9tIHByb2Nlc3Nlcy5cbiAgICAgICAgICAgIHZhciBwaWRzID0gc3Rkb3V0LnRyaW0oKS5zcGxpdCgnICcpLm1hcChwYXJzZUZsb2F0KTtcbiAgICAgICAgICAgIHJlc29sdmUocGlkcyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG4vKipcbiAqIEdldHMgdGhlIGhhbmRsZSBJRHMgb2YgYWxsIGN1cnJlbnRseSBvcGVuIEF0b20gd2luZG93cy5cbiAqXG4gKiBAcmV0dXJuIFByb21pc2VcbiAqL1xuZnVuY3Rpb24gZ2V0QXRvbVdpbmRvd0hhbmRsZXMoKSB7XG4gICAgLy8gRmlyc3QsIGdldCBhbGwgb2YgdGhlIG9wZW4gd2luZG93cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSBwcm9jZXNzIElEcy5cbiAgICB2YXIgd2luZG93UGlkcyA9IGdldEFsbFdpbmRvd0hhbmRsZXMoKS50aGVuKGZ1bmN0aW9uICh3aW5kb3dIYW5kbGVzKSB7XG4gICAgICAgIHZhciBwcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIC8vIEdvIHRocm91Z2ggZWFjaCBoYW5kbGUgYW5kIGZldGNoIGl0cyBvd25lciBwcm9jZXNzIElELlxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHdpbmRvd0hhbmRsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBoYW5kbGUgPSB3aW5kb3dIYW5kbGVzW2ldO1xuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChnZXRXaW5kb3dQcm9jZXNzSWQoaGFuZGxlKS50aGVuKGZ1bmN0aW9uKHBpZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZTogaGFuZGxlLFxuICAgICAgICAgICAgICAgICAgICBwaWQ6IHBpZFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH0pO1xuXG4gICAgLy8gTm93LCBnZXQgYWxsIG9mIEF0b20ncyBwcm9jZXNzZXMgYW5kIG1hdGNoIHRoZSB3aW5kb3cgaGFuZGxlcyB0byBzZWUgaWZcbiAgICAvLyB0aGV5IGJlbG9uZyB0byBBdG9tLlxuICAgIHZhciBwaWRzID0gZ2V0QXRvbVByb2Nlc3NJZHMoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoW3BpZHMsIHdpbmRvd1BpZHNdKS50aGVuKGZ1bmN0aW9uICh2YWx1ZXMpIHtcbiAgICAgICAgdmFyIGhhbmRsZXMgPSBbXTtcblxuICAgICAgICAvLyBGb3IgZWFjaCB3aW5kb3cgaGFuZGxlLCBpZiB0aGUgd2luZG93J3MgUElEIGlzIGluIHRoZSBsaXN0IG9mIEF0b21cbiAgICAgICAgLy8gUElEcywgYWRkIHRoZSB3aW5kb3cncyBoYW5kbGUgdG8gdGhlIGxpc3QuXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzWzFdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAodmFsdWVzWzFdW2ldICYmIHZhbHVlc1swXS5pbmRleE9mKHZhbHVlc1sxXVtpXS5waWQpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVzLnB1c2godmFsdWVzWzFdW2ldLmhhbmRsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaGFuZGxlcztcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBTZXRzIHRoZSBHVEsgdGhlbWUgdmFyaWFudCBvZiBhbGwgQXRvbSB3aW5kb3dzLlxuICpcbiAqIEBwYXJhbSBbU3RyaW5nXSB2YXJpYW50IFRoZSBHVEsgdGhlbWUgdmFyaWFudCB0byBzZXQuXG4gKlxuICogQHJldHVybiBQcm9taXNlXG4gKi9cbmZ1bmN0aW9uIHNldEF0b21HdGtUaGVtZSh0aGVtZSkge1xuICAgIHJldHVybiBnZXRBdG9tV2luZG93SGFuZGxlcygpLnRoZW4oZnVuY3Rpb24oaGFuZGxlcykge1xuICAgICAgICB2YXIgcHJvbWlzZXMgPSBbXTtcblxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBjbWQgPSAneHByb3AgLWlkICdcbiAgICAgICAgICAgICAgICArIGhhbmRsZXNbaV1cbiAgICAgICAgICAgICAgICArICcgLWYgX0dUS19USEVNRV9WQVJJQU5UIDh1IC1zZXQgX0dUS19USEVNRV9WQVJJQU5UICdcbiAgICAgICAgICAgICAgICArIHRoZW1lO1xuXG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIGV4ZWMoY21kLCBmdW5jdGlvbihlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH0pO1xufVxuXG4vKipcbiAqIEdldHMgdGhlIHdpbmRvdyBoYW5kbGUgSURzIG9mIGFsbCB3aW5kb3dzIGN1cnJlbnRseSBvcGVuLlxuICpcbiAqIEByZXR1cm4gUHJvbWlzZVxuICovXG5mdW5jdGlvbiBnZXRBbGxXaW5kb3dIYW5kbGVzKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZXhlYygneHByb3AgLXJvb3QgX05FVF9DTElFTlRfTElTVCcsIGZ1bmN0aW9uKGVycm9yLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBpZHMgPSBzdGRvdXQubWF0Y2goLzB4KChbYS16XXxcXGQpKykvZ2kpO1xuICAgICAgICAgICAgcmVzb2x2ZShpZHMpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBHZXRzIHRoZSBQSUQgb2YgdGhlIHByb2Nlc3MgdGhhdCBvd25zIGEgd2luZG93IGhhbmRsZSBJRC5cbiAqXG4gKiBAcGFyYW0gW1N0cmluZ10gaGFuZGxlIFRoZSB3aW5kb3cgaGFuZGxlIElELlxuICpcbiAqIEByZXR1cm4gUHJvbWlzZVxuICovXG5mdW5jdGlvbiBnZXRXaW5kb3dQcm9jZXNzSWQoaGFuZGxlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBleGVjKCd4cHJvcCAtaWQgJyArIGhhbmRsZSArICcgX05FVF9XTV9QSUQnLCBmdW5jdGlvbihlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnJvciB8fCBzdGRvdXQuaW5kZXhPZignX05FVF9XTV9QSUQoQ0FSRElOQUwpJykgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHBpZCA9IHBhcnNlRmxvYXQoc3Rkb3V0Lm1hdGNoKC9cXGQrLylbMF0pO1xuICAgICAgICAgICAgcmVzb2x2ZShwaWQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cbiJdfQ==