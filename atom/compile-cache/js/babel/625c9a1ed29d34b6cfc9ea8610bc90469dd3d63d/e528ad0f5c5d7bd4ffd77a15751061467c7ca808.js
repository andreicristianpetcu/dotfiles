//var d3 = require('d3');

var is_empty = function is_empty(obj) {
    if (obj == null) return true;
    if (obj.length > 0) return false;
    if (obj.length === 0) return true;
    for (var key in obj) {
        if (hasOwnProperty.call(obj, key)) return false;
    }
    return true;
};

function GitGraph(location, data, line_height, margin) {
    this.config = this.set_config(line_height, margin);
    this.set_position(data);
    var svg = this.render(location, data);
}

GitGraph.prototype.set_config = function (line_height, margin) {
    var config = {};
    var circle_radius_percent = 20;
    var circle_stroke_percent = 8;
    var branch_spacing_percent = 60;
    var line_width_percent = 10;

    var percentage = function percentage(percent) {
        return line_height * percent / 100;
    };

    config.circle = {};
    config.circle.radius = percentage(circle_radius_percent);
    config.circle.stroke = percentage(circle_stroke_percent);
    config.circle_spacing = line_height + margin;
    config.branch_spacing = percentage(branch_spacing_percent);
    config.line_width = percentage(line_width_percent);
    config.left_margin = line_height / 2;
    config.top_margin = line_height / 2;
    config.cross_height = 40 / 100;
    /*config.color_list = [
        "#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896",
        "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7",
        "#bcbd22", "#dbdb8d","#17becf", "#9edae5"
    ];
    config.color_list = [
        "#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c",
        "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c",
        "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"
    ];
    config.color_list = [
        "#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2",
        "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb",
        "#636363", "#969696", "#bdbdbd", "#d9d9d9"
    ];*/
    config.color_list = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];
    return config;
};

GitGraph.prototype.set_position = function (data) {
    var _i, _len;
    var curr_row, curr_col;
    var branches = [];
    this.max_level = 0;

    curr_row = curr_col = 0;

    var get_free_column = function get_free_column() {
        var i, len;
        for (i = 0; len = branches.length, i < len; i++) {
            if (branches[i] == null) return i;
        }
        return len;
    };

    var update_branch = function update_branch(parent, col) {
        branches[col] = parent;
    };

    var create_branch = function create_branch(commit) {
        var i, len, index, my_col, par_col;
        var par, sha1;

        if ((index = branches.indexOf(commit.sha1)) > -1) {
            my_col = index;
        } else {
            my_col = get_free_column();
        }
        while ((index = branches.indexOf(commit.sha1)) > -1) {
            branches[index] = null;
        }

        for (i = 0; len = commit.parents.length, i < len; i++) {
            par = commit.parents[i];

            if ((index = branches.indexOf(par)) > -1) {
                if (branches[my_col] == null) update_branch(par, my_col);
            } else {
                if (len == 1 || i == 0) {
                    // dont create new branch
                    update_branch(par, my_col);
                } else {
                    par_col = get_free_column();
                    update_branch(par, par_col);
                }
            }
        }
        return my_col;
    };

    for (_i = 0; _len = data.length, _i < _len; _i++) {
        var commit = data[_i];
        var position = {};

        position.column = create_branch(commit);
        if (position.column > this.max_level) this.max_column = position.column;
        position.row = curr_row++;
        commit.position = position;
    }
    this.max_row = curr_row;
};

GitGraph.prototype.commit_search = function (data, commit) {
    var i, len;
    for (i = 0; len = data.length, i < len; i++) {
        if (data[i].sha1 === commit) return i;
    }
};

GitGraph.prototype.lines = function (data) {
    var create_mid_point = function create_mid_point(start, end, height) {
        var point = {};
        if (start.x == end.x) {
            return false;
        } else if (start.x < end.x) {
            point.x = end.x;
            point.y = start.y + height;
        } else {
            point.x = start.x;
            point.y = end.y - height;
        }
        return point;
    };

    var i, len;
    var height = this.config.cross_height;
    var colors = this.config.color_list;
    var line_array = [];
    var line_color = [];
    for (i = 0; len = data.length, i < len; i++) {
        var commit, j, _len;
        commit = data[i];
        // assign color for commit
        if (line_color[commit.position.column] == null) {
            clr = colors.shift();
            colors.push(clr);
            line_color[commit.position.column] = clr;
        } else {
            clr = line_color[commit.position.column];
        }
        commit.position.color = clr;

        for (j = 0; _len = commit.parents.length, j < _len; j++) {
            var line = [];
            var start, mid, end, clr;
            start = {};mid = {};end = {};

            var index = this.commit_search(data, commit.parents[j]);
            var parent = data[index];

            start.x = commit.position.column;
            start.y = commit.position.row;
            end.x = parent.position.column;
            end.y = parent.position.row;

            if (start.x < end.x) {

                mid.x = end.x;
                mid.y = start.y + height;
                clr = colors.shift();
                colors.push(clr);

                line_color[end.x] = clr;
            } else if (start.x > end.x) {
                mid.x = start.x;
                mid.y = end.y - height;
                line_color[start.x] = null;
            }
            start.color = clr;
            line.push(start);
            if (is_empty(mid) == false) line.push(mid);
            line.push(end);
            line_array.push(line);
        }
    }
    return line_array;
};

GitGraph.prototype.render = function (location, data) {
    var line_array = this.lines(data);
    var self = this;

    var create_line = function create_line(d) {
        var x, y, point_no;
        var line;
        point_no = 1;
        for (var i = 0; len = d.length, i < len; i++) {
            x = self.config.left_margin + d[i].x * self.config.branch_spacing;
            y = self.config.top_margin + d[i].y * self.config.circle_spacing;
            if (point_no == 1) {
                line = "M" + x + ',' + y;
                point_no++;
            } else {
                line += "L" + x + ',' + y;
            }
        }
        return line;
    };

    var create_element = function create_element(type) {
        return document.createElementNS("http://www.w3.org/2000/svg", type);
    };

    var height = this.config.top_margin + this.max_row * this.config.circle_spacing;

    var svg = create_element("svg");

    var line_group = svg.appendChild(create_element("g"));
    var circle_group = svg.appendChild(create_element("g"));

    circle_group.setAttribute("stoke-width", self.config.circle.stroke);
    circle_group.setAttribute("stroke", "#000");

    data.forEach(function (d) {
        var circle = circle_group.appendChild(create_element("circle"));
        circle.setAttribute("cx", self.config.left_margin + d.position.column * self.config.branch_spacing);
        circle.setAttribute("cy", self.config.top_margin + d.position.row * self.config.circle_spacing);
        circle.setAttribute("r", self.config.circle.radius);
        circle.setAttribute("fill", d.position.color);
    });

    line_group.setAttribute("stroke", "#000");
    line_group.setAttribute("stroke-width", this.config.line_width);
    line_group.setAttribute("fill", "none");

    line_array.forEach(function (d) {
        var path = line_group.appendChild(create_element("path"));
        path.setAttribute("d", create_line(d));
        path.setAttribute("stroke", d[0].color);
    });

    location.append(svg);
    svg.setAttribute("width", svg.childNodes[1].getBoundingClientRect().width + this.config.left_margin);
    svg.setAttribute("height", height);
    return svg;
};

module.exports = GitGraph;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2FuZHJlaS8uYXRvbS9wYWNrYWdlcy9naXQtbG9nL2xpYi9naXRncmFwaC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLElBQUksUUFBUSxHQUFHLFNBQVgsUUFBUSxDQUFZLEdBQUcsRUFBRTtBQUN6QixRQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsT0FBTyxJQUFJLENBQUM7QUFDN0IsUUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBSyxPQUFPLEtBQUssQ0FBQztBQUNwQyxRQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFHLE9BQU8sSUFBSSxDQUFDO0FBQ25DLFNBQUssSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFO0FBQ2pCLFlBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsT0FBTyxLQUFLLENBQUM7S0FDbkQ7QUFDRCxXQUFPLElBQUksQ0FBQztDQUNmLENBQUM7O0FBRUYsU0FBUyxRQUFRLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFO0FBQ25ELFFBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDbkQsUUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN4QixRQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztDQUN6Qzs7QUFFRCxRQUFRLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFTLFdBQVcsRUFBRSxNQUFNLEVBQUU7QUFDMUQsUUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ2hCLFFBQUkscUJBQXFCLEdBQUcsRUFBRSxDQUFDO0FBQy9CLFFBQUkscUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0FBQzlCLFFBQUksc0JBQXNCLEdBQUcsRUFBRSxDQUFDO0FBQ2hDLFFBQUksa0JB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LENBQUM7S0FDM0MsQ0FBQyxDQUFBOztBQUVGLFlBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDckIsT0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3JHLE9BQUcsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ25DLFdBQU8sR0FBRyxDQUFDO0NBQ2QsQ0FBQzs7QUFFRixNQUFNLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyIsImZpbGUiOiIvaG9tZS9hbmRyZWkvLmF0b20vcGFja2FnZXMvZ2l0LWxvZy9saWIvZ2l0Z3JhcGguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvL3ZhciBkMyA9IHJlcXVpcmUoJ2QzJyk7XG5cblxudmFyIGlzX2VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7XG4gICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTtcbiAgICBpZiAob2JqLmxlbmd0aCA+IDApICAgIHJldHVybiBmYWxzZTtcbiAgICBpZiAob2JqLmxlbmd0aCA9PT0gMCkgIHJldHVybiB0cnVlO1xuICAgIGZvciAodmFyIGtleSBpbiBvYmopIHtcbiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufTtcblxuZnVuY3Rpb24gR2l0R3JhcGgobG9jYXRpb24sIGRhdGEsIGxpbmVfaGVpZ2h0LCBtYXJnaW4pIHtcbiAgICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0X2NvbmZpZyhsaW5lX2hlaWdodCwgbWFyZ2luKTtcbiAgICB0aGlzLnNldF9wb3NpdGlvbihkYXRhKTtcbiAgICB2YXIgc3ZnID0gdGhpcy5yZW5kZXIobG9jYXRpb24sIGRhdGEpO1xufVxuXG5HaXRHcmFwaC5wcm90b3R5cGUuc2V0X2NvbmZpZyA9IGZ1bmN0aW9uKGxpbmVfaGVpZ2h0LCBtYXJnaW4pIHtcbiAgICB2YXIgY29uZmlnID0ge307XG4gICAgdmFyIGNpcmNsZV9yYWRpdXNfcGVyY2VudCA9IDIwO1xuICAgIHZhciBjaXJjbGVfc3Ryb2tlX3BlcmNlbnQgPSA4O1xuICAgIHZhciBicmFuY2hfc3BhY2luZ19wZXJjZW50ID0gNjA7XG4gICAgdmFyIGxpbmVfd2lkdGhfcGVyY2VudCA9IDEwO1xuXG4gICAgdmFyIHBlcmNlbnRhZ2UgPSBmdW5jdGlvbihwZXJjZW50KSB7XG4gICAgICAgIHJldHVybiAobGluZV9oZWlnaHQgKiBwZXJjZW50KS8xMDA7XG4gICAgfVxuXG4gICAgY29uZmlnLmNpcmNsZSA9IHt9O1xuICAgIGNvbmZpZy5jaXJjbGUucmFkaXVzID0gcGVyY2VudGFnZShjaXJjbGVfcmFkaXVzX3BlcmNlbnQpO1xuICAgIGNvbmZpZy5jaXJjbGUuc3Ryb2tlID0gcGVyY2VudGFnZShjaXJjbGVfc3Ryb2tlX3BlcmNlbnQpO1xuICAgIGNvbmZpZy5jaXJjbGVfc3BhY2luZyA9IGxpbmVfaGVpZ2h0ICsgbWFyZ2luO1xuICAgIGNvbmZpZy5icmFuY2hfc3BhY2luZyA9IHBlcmNlbnRhZ2UoYnJhbmNoX3NwYWNpbmdfcGVyY2VudCk7XG4gICAgY29uZmlnLmxpbmVfd2lkdGggPSBwZXJjZW50YWdlKGxpbmVfd2lkdGhfcGVyY2VudCk7XG4gICAgY29uZmlnLmxlZnRfbWFyZ2luID0gbGluZV9oZWlnaHQgLyAyO1xuICAgIGNvbmZpZy50b3BfbWFyZ2luID0gbGluZV9oZWlnaHQgLyAyO1xuICAgIGNvbmZpZy5jcm9zc19oZWlnaHQgPSA0MC8xMDA7XG4gICAgLypjb25maWcuY29sb3JfbGlzdCA9IFtcbiAgICAgICAgXCIjMWY3N2I0XCIsIFwiI2FlYzdlOFwiLCBcIiNmZjdmMGVcIiwgXCIjZmZiYjc4XCIsIFwiIzJjYTAyY1wiLCBcIiM5OGRmOGFcIiwgXCIjZDYyNzI4XCIsIFwiI2ZmOTg5NlwiLFxuICAgICAgICBcIiM5NDY3YmRcIiwgXCIjYzViMGQ1XCIsIFwiIzhjNTY0YlwiLCBcIiNjNDljOTRcIiwgXCIjZTM3N2MyXCIsIFwiI2Y3YjZkMlwiLCBcIiM3ZjdmN2ZcIiwgXCIjYzdjN2M3XCIsXG4gICAgICAgIFwiI2JjYmQyMlwiLCBcIiNkYmRiOGRcIixcIiMxN2JlY2ZcIiwgXCIjOWVkYWU1XCJcbiAgICBdO1xuICAgIGNvbmZpZy5jb2xvcl9saXN0ID0gW1xuICAgICAgICBcIiMzOTNiNzlcIiwgXCIjNTI1NGEzXCIsIFwiIzZiNmVjZlwiLCBcIiM5YzllZGVcIiwgXCIjNjM3OTM5XCIsIFwiIzhjYTI1MlwiLCBcIiNiNWNmNmJcIiwgXCIjY2VkYjljXCIsXG4gICAgICAgIFwiIzhjNmQzMVwiLCBcIiNiZDllMzlcIiwgXCIjZTdiYTUyXCIsIFwiI2U3Y2I5NFwiLCBcIiM4NDNjMzlcIiwgXCIjYWQ0OTRhXCIsIFwiI2Q2NjE2YlwiLCBcIiNlNzk2OWNcIixcbiAgICAgICAgXCIjN2I0MTczXCIsIFwiI2E1NTE5NFwiLCBcIiNjZTZkYmRcIiwgXCIjZGU5ZWQ2XCJcbiAgICBdO1xuICAgIGNvbmZpZy5jb2xvcl9saXN0ID0gW1xuICAgICAgICBcIiMzMTgyYmRcIiwgXCIjNmJhZWQ2XCIsIFwiIzllY2FlMVwiLCBcIiNjNmRiZWZcIiwgXCIjZTY1NTBkXCIsIFwiI2ZkOGQzY1wiLCBcIiNmZGFlNmJcIiwgXCIjZmRkMGEyXCIsXG4gICAgICAgIFwiIzMxYTM1NFwiLCBcIiM3NGM0NzZcIiwgXCIjYTFkOTliXCIsIFwiI2M3ZTljMFwiLCBcIiM3NTZiYjFcIiwgXCIjOWU5YWM4XCIsIFwiI2JjYmRkY1wiLCBcIiNkYWRhZWJcIixcbiAgICAgICAgXCIjNjM2MzYzXCIsIFwiIzk2OTY5NlwiLCBcIiNiZGJkYmRcIiwgXCIjZDlkOWQ5XCJcbiAgICBdOyovXG4gICAgY29uZmlnLmNvbG9yX2xpc3QgPSBbXG4gICAgICAgIFwiIzFmNzdiNFwiLCBcIiNmZjdmMGVcIiwgXCIjMmNhMDJjXCIsIFwiI2Q2MjcyOFwiLCBcIiM5NDY3YmRcIiwgXCIjOGM1NjRiXCIsIFwiI2UzNzdjMlwiLCBcIiM3ZjdmN2ZcIixcbiAgICAgICAgXCIjYmNiZDIyXCIsIFwiIzE3YmVjZlwiXG4gICAgXTtcbiAgICByZXR1cm4gY29uZmlnO1xufTtcblxuR2l0R3JhcGgucHJvdG90eXBlLnNldF9wb3NpdGlvbiA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgX2ksIF9sZW47XG4gICAgdmFyIGN1cnJfcm93LCBjdXJyX2NvbDtcbiAgICB2YXIgYnJhbmNoZXMgPSBbXTtcbiAgICB0aGlzLm1heF9sZXZlbCA9IDA7XG5cbiAgICBjdXJyX3JvdyA9IGN1cnJfY29sID0gMDtcblxuICAgIHZhciBnZXRfZnJlZV9jb2x1bW4gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIGksIGxlbjtcbiAgICAgICAgZm9yKGk9MDsgbGVuID0gYnJhbmNoZXMubGVuZ3RoLCBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgIGlmKGJyYW5jaGVzW2ldID09IG51bGwpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxlbjtcbiAgICB9XG5cbiAgICB2YXIgdXBkYXRlX2JyYW5jaCA9IGZ1bmN0aW9uKHBhcmVudCwgY29sKSB7XG4gICAgICAgIGJyYW5jaGVzW2NvbF0gPSBwYXJlbnQ7XG4gICAgfVxuXG4gICAgdmFyIGNyZWF0ZV9icmFuY2ggPSBmdW5jdGlvbihjb21taXQpIHtcbiAgICAgICAgdmFyIGksIGxlbiwgaW5kZXgsIG15X2NvbCwgcGFyX2NvbDtcbiAgICAgICAgdmFyIHBhciwgc2hhMTtcblxuICAgICAgICBpZigoaW5kZXggPSBicmFuY2hlcy5pbmRleE9mKGNvbW1pdC5zaGExKSkgPiAtMSkge1xuICAgICAgICAgICAgbXlfY29sID0gaW5kZXg7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBteV9jb2wgPSBnZXRfZnJlZV9jb2x1bW4oKTtcbiAgICAgICAgfVxuICAgICAgICB3aGlsZSgoaW5kZXggPSBicmFuY2hlcy5pbmRleE9mKGNvbW1pdC5zaGExKSkgPiAtMSkge1xuICAgICAgICAgICAgYnJhbmNoZXNbaW5kZXhdID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvcihpPTA7IGxlbiA9IGNvbW1pdC5wYXJlbnRzLmxlbmd0aCwgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICBwYXIgPSBjb21taXQucGFyZW50c1tpXTtcblxuICAgICAgICAgICAgaWYoKGluZGV4ID0gYnJhbmNoZXMuaW5kZXhPZihwYXIpKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgaWYoKGJyYW5jaGVzW215X2NvbF0gPT0gbnVsbCkpXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9icmFuY2gocGFyLCBteV9jb2wpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYobGVuID09IDEgfHwgaSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGRvbnQgY3JlYXRlIG5ldyBicmFuY2hcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2JyYW5jaChwYXIsIG15X2NvbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwYXJfY29sID0gZ2V0X2ZyZWVfY29sdW1uKCk7XG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9icmFuY2gocGFyLCBwYXJfY29sKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG15X2NvbDtcbiAgICB9XG5cbiAgICBmb3IoX2k9MDsgX2xlbiA9IGRhdGEubGVuZ3RoLCBfaSA8IF9sZW47IF9pKyspIHtcbiAgICAgICAgdmFyIGNvbW1pdCA9IGRhdGFbX2ldO1xuICAgICAgICB2YXIgcG9zaXRpb24gPSB7fTtcblxuICAgICAgICBwb3NpdGlvbi5jb2x1bW4gPSBjcmVhdGVfYnJhbmNoKGNvbW1pdCk7XG4gICAgICAgIGlmKHBvc2l0aW9uLmNvbHVtbiA+IHRoaXMubWF4X2xldmVsKVxuICAgICAgICAgICAgdGhpcy5tYXhfY29sdW1uID0gcG9zaXRpb24uY29sdW1uO1xuICAgICAgICBwb3NpdGlvbi5yb3cgPSBjdXJyX3JvdysrO1xuICAgICAgICBjb21taXQucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgIH1cbiAgIHRoaXMubWF4X3JvdyA9IGN1cnJfcm93O1xufVxuXG5HaXRHcmFwaC5wcm90b3R5cGUuY29tbWl0X3NlYXJjaCA9IGZ1bmN0aW9uKGRhdGEsIGNvbW1pdCkge1xuICAgIHZhciBpLCBsZW47XG4gICAgZm9yKGk9MDsgbGVuID0gZGF0YS5sZW5ndGgsIGkgPCBsZW47IGkrKykge1xuICAgICAgICBpZihkYXRhW2ldLnNoYTEgPT09IGNvbW1pdClcbiAgICAgICAgICAgIHJldHVybiBpO1xuICAgIH1cbn07XG5cbkdpdEdyYXBoLnByb3RvdHlwZS5saW5lcyA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgY3JlYXRlX21pZF9wb2ludCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIGhlaWdodCkge1xuICAgICAgICB2YXIgcG9pbnQgPSB7fTtcbiAgICAgICAgaWYoc3RhcnQueCA9PSBlbmQueCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYoc3RhcnQueCA8IGVuZC54KSB7XG4gICAgICAgICAgICBwb2ludC54ID0gZW5kLng7XG4gICAgICAgICAgICBwb2ludC55ID0gc3RhcnQueSArIGhlaWdodDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHBvaW50LnggPSBzdGFydC54O1xuICAgICAgICAgICAgcG9pbnQueSA9IGVuZC55IC0gaGVpZ2h0O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwb2ludDtcbiAgICB9O1xuXG4gICAgdmFyIGksIGxlbjtcbiAgICB2YXIgaGVpZ2h0ID0gdGhpcy5jb25maWcuY3Jvc3NfaGVpZ2h0O1xuICAgIHZhciBjb2xvcnMgPSB0aGlzLmNvbmZpZy5jb2xvcl9saXN0O1xuICAgIHZhciBsaW5lX2FycmF5ID0gW107XG4gICAgdmFyIGxpbmVfY29sb3IgPSBbXTtcbiAgICBmb3IoaT0wOyBsZW4gPSBkYXRhLmxlbmd0aCwgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIHZhciBjb21taXQsIGosIF9sZW47XG4gICAgICAgIGNvbW1pdCA9IGRhdGFbaV07XG4gICAgICAgIC8vIGFzc2lnbiBjb2xvciBmb3IgY29tbWl0XG4gICAgICAgIGlmKGxpbmVfY29sb3JbY29tbWl0LnBvc2l0aW9uLmNvbHVtbl0gPT0gbnVsbCkge1xuICAgICAgICAgICAgY2xyID0gY29sb3JzLnNoaWZ0KCk7XG4gICAgICAgICAgICBjb2xvcnMucHVzaChjbHIpO1xuICAgICAgICAgICAgbGluZV9jb2xvcltjb21taXQucG9zaXRpb24uY29sdW1uXSA9IGNscjtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNsciA9IGxpbmVfY29sb3JbY29tbWl0LnBvc2l0aW9uLmNvbHVtbl07XG4gICAgICAgIH1cbiAgICAgICAgY29tbWl0LnBvc2l0aW9uLmNvbG9yID0gY2xyO1xuXG4gICAgICAgIGZvcihqPTA7IF9sZW4gPSBjb21taXQucGFyZW50cy5sZW5ndGgsIGogPCBfbGVuOyBqKyspIHtcbiAgICAgICAgICAgIHZhciBsaW5lID0gW107XG4gICAgICAgICAgICB2YXIgc3RhcnQsIG1pZCwgZW5kLCBjbHI7XG4gICAgICAgICAgICBzdGFydD17fTsgbWlkPXt9OyBlbmQ9e307XG5cbiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29tbWl0X3NlYXJjaChkYXRhLCBjb21taXQucGFyZW50c1tqXSk7XG4gICAgICAgICAgICB2YXIgcGFyZW50ID0gZGF0YVtpbmRleF07XG5cbiAgICAgICAgICAgIHN0YXJ0LnggPSBjb21taXQucG9zaXRpb24uY29sdW1uO1xuICAgICAgICAgICAgc3RhcnQueSA9IGNvbW1pdC5wb3NpdGlvbi5yb3c7XG4gICAgICAgICAgICBlbmQueCA9IHBhcmVudC5wb3NpdGlvbi5jb2x1bW47XG4gICAgICAgICAgICBlbmQueSA9IHBhcmVudC5wb3NpdGlvbi5yb3c7XG5cbiAgICAgICAgICAgIGlmKHN0YXJ0LnggPCBlbmQueCkge1xuXG4gICAgICAgICAgICAgICAgbWlkLnggPSBlbmQueDtcbiAgICAgICAgICAgICAgICBtaWQueSA9IHN0YXJ0LnkgKyBoZWlnaHQ7XG4gICAgICAgICAgICAgICAgY2xyID0gY29sb3JzLnNoaWZ0KCk7XG4gICAgICAgICAgICAgICAgY29sb3JzLnB1c2goY2xyKTtcblxuICAgICAgICAgICAgICAgIGxpbmVfY29sb3JbZW5kLnhdID0gY2xyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZihzdGFydC54ID4gZW5kLngpIHtcbiAgICAgICAgICAgICAgICBtaWQueCA9IHN0YXJ0Lng7XG4gICAgICAgICAgICAgICAgbWlkLnkgPSBlbmQueSAtIGhlaWdodDtcbiAgICAgICAgICAgICAgICBsaW5lX2NvbG9yW3N0YXJ0LnhdID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXJ0LmNvbG9yID0gY2xyO1xuICAgICAgICAgICAgbGluZS5wdXNoKHN0YXJ0KTtcbiAgICAgICAgICAgIGlmKGlzX2VtcHR5KG1pZCkgPT0gZmFsc2UpXG4gICAgICAgICAgICAgICAgbGluZS5wdXNoKG1pZCk7XG4gICAgICAgICAgICBsaW5lLnB1c2goZW5kKTtcbiAgICAgICAgICAgIGxpbmVfYXJyYXkucHVzaChsaW5lKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbGluZV9hcnJheTtcbn07XG5cbkdpdEdyYXBoLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihsb2NhdGlvbiwgZGF0YSkge1xuICAgIHZhciBsaW5lX2FycmF5ID0gdGhpcy5saW5lcyhkYXRhKTtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICB2YXIgY3JlYXRlX2xpbmUgPSBmdW5jdGlvbihkKSB7XG4gICAgICAgIHZhciB4LCB5LCBwb2ludF9ubztcbiAgICAgICAgdmFyIGxpbmU7XG4gICAgICAgIHBvaW50X25vID0gMTtcbiAgICAgICAgZm9yKHZhciBpPTA7IGxlbiA9IGQubGVuZ3RoLCBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgIHggPSBzZWxmLmNvbmZpZy5sZWZ0X21hcmdpbiArIChkW2ldLnggKiBzZWxmLmNvbmZpZy5icmFuY2hfc3BhY2luZyk7XG4gICAgICAgICAgICB5ID0gc2VsZi5jb25maWcudG9wX21hcmdpbiArIChkW2ldLnkgKiBzZWxmLmNvbmZpZy5jaXJjbGVfc3BhY2luZylcbiAgICAgICAgICAgIGlmKHBvaW50X25vID09IDEpIHtcbiAgICAgICAgICAgICAgICBsaW5lID0gXCJNXCIgKyB4ICsgJywnICsgeTtcbiAgICAgICAgICAgICAgICBwb2ludF9ubysrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbGluZSs9IFwiTFwiICsgeCArICcsJyArIHk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxpbmU7XG4gICAgfTtcblxuICAgIHZhciBjcmVhdGVfZWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUpIHtcbiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhcImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCIsIHR5cGUpO1xuICAgIH07XG5cbiAgICB2YXIgaGVpZ2h0ID0gdGhpcy5jb25maWcudG9wX21hcmdpbiArIHRoaXMubWF4X3JvdyAqIHRoaXMuY29uZmlnLmNpcmNsZV9zcGFjaW5nO1xuXG4gICAgdmFyIHN2ZyA9IGNyZWF0ZV9lbGVtZW50KFwic3ZnXCIpO1xuXG4gICAgdmFyIGxpbmVfZ3JvdXAgPSBzdmcuYXBwZW5kQ2hpbGQoY3JlYXRlX2VsZW1lbnQoXCJnXCIpKTtcbiAgICB2YXIgY2lyY2xlX2dyb3VwID0gc3ZnLmFwcGVuZENoaWxkKGNyZWF0ZV9lbGVtZW50KFwiZ1wiKSk7XG5cbiAgICBjaXJjbGVfZ3JvdXAuc2V0QXR0cmlidXRlKFwic3Rva2Utd2lkdGhcIiwgc2VsZi5jb25maWcuY2lyY2xlLnN0cm9rZSk7XG4gICAgY2lyY2xlX2dyb3VwLnNldEF0dHJpYnV0ZShcInN0cm9rZVwiLCBcIiMwMDBcIik7XG5cbiAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24oZCkge1xuICAgICAgICB2YXIgY2lyY2xlID0gY2lyY2xlX2dyb3VwLmFwcGVuZENoaWxkKGNyZWF0ZV9lbGVtZW50KFwiY2lyY2xlXCIpKTtcbiAgICAgICAgY2lyY2xlLnNldEF0dHJpYnV0ZShcImN4XCIsIChzZWxmLmNvbmZpZy5sZWZ0X21hcmdpbiArIChkLnBvc2l0aW9uLmNvbHVtbiAqIHNlbGYuY29uZmlnLmJyYW5jaF9zcGFjaW5nKSkpO1xuICAgICAgICBjaXJjbGUuc2V0QXR0cmlidXRlKFwiY3lcIiwgKHNlbGYuY29uZmlnLnRvcF9tYXJnaW4gKyAoZC5wb3NpdGlvbi5yb3cgKiBzZWxmLmNvbmZpZy5jaXJjbGVfc3BhY2luZykpKTtcbiAgICAgICAgY2lyY2xlLnNldEF0dHJpYnV0ZShcInJcIiwgc2VsZi5jb25maWcuY2lyY2xlLnJhZGl1cyk7XG4gICAgICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoXCJmaWxsXCIsIGQucG9zaXRpb24uY29sb3IpO1xuICAgIH0pXG5cbiAgICBsaW5lX2dyb3VwLnNldEF0dHJpYnV0ZShcInN0cm9rZVwiLCBcIiMwMDBcIik7XG4gICAgbGluZV9ncm91cC5zZXRBdHRyaWJ1dGUoXCJzdHJva2Utd2lkdGhcIiwgdGhpcy5jb25maWcubGluZV93aWR0aCk7XG4gICAgbGluZV9ncm91cC5zZXRBdHRyaWJ1dGUoXCJmaWxsXCIsIFwibm9uZVwiKTtcblxuXG4gICAgbGluZV9hcnJheS5mb3JFYWNoKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgdmFyIHBhdGggPSBsaW5lX2dyb3VwLmFwcGVuZENoaWxkKGNyZWF0ZV9lbGVtZW50KFwicGF0aFwiKSk7XG4gICAgICAgIHBhdGguc2V0QXR0cmlidXRlKFwiZFwiLCBjcmVhdGVfbGluZShkKSk7XG4gICAgICAgIHBhdGguc2V0QXR0cmlidXRlKFwic3Ryb2tlXCIsIGRbMF0uY29sb3IpO1xuICAgIH0pXG5cbiAgICBsb2NhdGlvbi5hcHBlbmQoc3ZnKTtcbiAgICBzdmcuc2V0QXR0cmlidXRlKFwid2lkdGhcIiwgc3ZnLmNoaWxkTm9kZXNbMV0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggKyB0aGlzLmNvbmZpZy5sZWZ0X21hcmdpbik7XG4gICAgc3ZnLnNldEF0dHJpYnV0ZShcImhlaWdodFwiLCBoZWlnaHQpO1xuICAgIHJldHVybiBzdmc7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IEdpdEdyYXBoO1xuIl19